{"version":3,"sources":["public/src/admin/settings/email.js"],"names":["define","ace","module","emailEditor","init","configureEmailTester","configureEmailEditor","handleDigestHourChange","handleSmtpServiceChange","$","window","on","socket","emit","change","off","template","val","err","console","error","message","app","alertError","alertSuccess","updateEmailEditor","edit","$blockScrolling","Infinity","setTheme","getSession","setMode","emailPath","original","ajaxify","data","emails","forEach","email","path","newEmail","getValue","setValue","text","attr","hour","parseInt","isNaN","now","date","Date","timestamp","offset","getTimezoneOffset","setHours","getHours","toLocaleTimeString","getTime","setDate","getDate","toLocaleString","isCustom"],"mappings":"AAAA,aAGAA,OAAO,wBAAyB,UAAW,kBAAmB,SAAUC,GACvE,IAAIC,KACJ,IAAIC,EAEJD,EAAOE,KAAO,WACbC,IACAC,IACAC,IACAC,IAEAC,EAAEC,QAAQC,GAAG,yDAA0DJ,GACvEE,EAAEC,QAAQC,GAAG,6BAA8B,WAC1CC,OAAOC,KAAK,4BAEbJ,EAAE,sCAAsCK,OAAON,IAGhD,SAASH,IACRI,EAAE,oCAAoCM,IAAI,SAASJ,GAAG,QAAS,WAC9DC,OAAOC,KAAK,oBAAsBG,SAAUP,EAAE,eAAeQ,OAAS,SAAUC,GAC/E,GAAIA,EAAK,CACRC,QAAQC,MAAMF,EAAIG,SAClB,OAAOC,IAAIC,WAAWL,EAAIG,SAE3BC,IAAIE,aAAa,qBAElB,OAAO,QAIT,SAASlB,IACRG,EAAE,0BAA0BE,GAAG,SAAUc,GAEzCtB,EAAcF,EAAIyB,KAAK,gBACvBvB,EAAYwB,gBAAkBC,SAC9BzB,EAAY0B,SAAS,sBACrB1B,EAAY2B,aAAaC,QAAQ,iBAEjC5B,EAAYQ,GAAG,SAAU,WACxB,IAAIqB,EAAYvB,EAAE,0BAA0BQ,MAC5C,IAAIgB,EACJC,QAAQC,KAAKC,OAAOC,QAAQ,SAAUC,GACrC,GAAIA,EAAMC,OAASP,EAAW,CAC7BC,EAAWK,EAAML,YAGnB,IAAIO,EAAWrC,EAAYsC,WAC3BhC,EAAE,wBAAwBQ,IAAIuB,IAAaP,EAAWO,EAAW,MAGlE/B,EAAE,sCAAsCM,IAAI,SAASJ,GAAG,QAAS,WAChEuB,QAAQC,KAAKC,OAAOC,QAAQ,SAAUC,GACrC,GAAIA,EAAMC,OAAS9B,EAAE,0BAA0BQ,MAAO,CACrDd,EAAY2B,aAAaY,SAASJ,EAAML,UACxCxB,EAAE,wBAAwBQ,IAAI,SAKjCQ,IAGD,SAASA,IACRS,QAAQC,KAAKC,OAAOC,QAAQ,SAAUC,GACrC,GAAIA,EAAMC,OAAS9B,EAAE,0BAA0BQ,MAAO,CACrDd,EAAY2B,aAAaY,SAASJ,EAAMK,MACxClC,EAAE,wBACAQ,IAAIqB,EAAMK,OAASL,EAAML,SAAWK,EAAMK,KAAO,IACjDC,KAAK,aAAc,gBAAkBN,EAAMC,SAKhD,SAAShC,IACR,IAAIsC,EAAOC,SAASrC,EAAE,eAAeQ,MAAO,IAE5C,GAAI8B,MAAMF,GAAO,CAChBA,EAAO,QACD,GAAIA,EAAO,IAAMA,EAAO,EAAG,CACjCA,EAAO,EAGRjC,OAAOC,KAAK,yBAA2B,SAAUK,EAAK8B,GACrD,GAAI9B,EAAK,CACR,OAAOI,IAAIC,WAAWL,EAAIG,SAG3B,IAAI4B,EAAO,IAAIC,KAAKF,EAAIG,WACxB,IAAIC,IAAU,IAAIF,MAAOG,oBAAsBL,EAAII,QAAU,GAC7DH,EAAKK,SAASL,EAAKM,WAAaH,GAEhC3C,EAAE,eAAekC,KAAKM,EAAKO,sBAE3BP,EAAKK,SAASR,SAASD,EAAM,IAAMO,EAAQ,EAAG,EAAG,GAGjD,GAAIH,EAAKQ,UAAYP,KAAKF,MAAO,CAChCC,EAAKS,QAAQT,EAAKU,UAAY,GAG/BlD,EAAE,mBAAmBkC,KAAKM,EAAKW,oBAIjC,SAASpD,IACR,IAAIqD,EAAWpD,EAAE,sCAAsCQ,QAAU,qBACjER,EAAE,6CAA6CoD,EAAW,YAAc,WAAWA,GAGpF,OAAO3D","file":"public/src/admin/settings/email.js","sourcesContent":["'use strict';\n\n\ndefine('admin/settings/email', ['ace/ace', 'admin/settings'], function (ace) {\n\tvar module = {};\n\tvar emailEditor;\n\n\tmodule.init = function () {\n\t\tconfigureEmailTester();\n\t\tconfigureEmailEditor();\n\t\thandleDigestHourChange();\n\t\thandleSmtpServiceChange();\n\n\t\t$(window).on('action:admin.settingsLoaded action:admin.settingsSaved', handleDigestHourChange);\n\t\t$(window).on('action:admin.settingsSaved', function () {\n\t\t\tsocket.emit('admin.user.restartJobs');\n\t\t});\n\t\t$('[id=\"email:smtpTransport:service\"]').change(handleSmtpServiceChange);\n\t};\n\n\tfunction configureEmailTester() {\n\t\t$('button[data-action=\"email.test\"]').off('click').on('click', function () {\n\t\t\tsocket.emit('admin.email.test', { template: $('#test-email').val() }, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err.message);\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tapp.alertSuccess('Test Email Sent');\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tfunction configureEmailEditor() {\n\t\t$('#email-editor-selector').on('change', updateEmailEditor);\n\n\t\temailEditor = ace.edit('email-editor');\n\t\temailEditor.$blockScrolling = Infinity;\n\t\temailEditor.setTheme('ace/theme/twilight');\n\t\temailEditor.getSession().setMode('ace/mode/html');\n\n\t\temailEditor.on('change', function () {\n\t\t\tvar emailPath = $('#email-editor-selector').val();\n\t\t\tvar original;\n\t\t\tajaxify.data.emails.forEach(function (email) {\n\t\t\t\tif (email.path === emailPath) {\n\t\t\t\t\toriginal = email.original;\n\t\t\t\t}\n\t\t\t});\n\t\t\tvar newEmail = emailEditor.getValue();\n\t\t\t$('#email-editor-holder').val(newEmail !== original ? newEmail : '');\n\t\t});\n\n\t\t$('button[data-action=\"email.revert\"]').off('click').on('click', function () {\n\t\t\tajaxify.data.emails.forEach(function (email) {\n\t\t\t\tif (email.path === $('#email-editor-selector').val()) {\n\t\t\t\t\temailEditor.getSession().setValue(email.original);\n\t\t\t\t\t$('#email-editor-holder').val('');\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tupdateEmailEditor();\n\t}\n\n\tfunction updateEmailEditor() {\n\t\tajaxify.data.emails.forEach(function (email) {\n\t\t\tif (email.path === $('#email-editor-selector').val()) {\n\t\t\t\temailEditor.getSession().setValue(email.text);\n\t\t\t\t$('#email-editor-holder')\n\t\t\t\t\t.val(email.text !== email.original ? email.text : '')\n\t\t\t\t\t.attr('data-field', 'email:custom:' + email.path);\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction handleDigestHourChange() {\n\t\tvar hour = parseInt($('#digestHour').val(), 10);\n\n\t\tif (isNaN(hour)) {\n\t\t\thour = 17;\n\t\t} else if (hour > 23 || hour < 0) {\n\t\t\thour = 0;\n\t\t}\n\n\t\tsocket.emit('admin.getServerTime', {}, function (err, now) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tvar date = new Date(now.timestamp);\n\t\t\tvar offset = (new Date().getTimezoneOffset() - now.offset) / 60;\n\t\t\tdate.setHours(date.getHours() + offset);\n\n\t\t\t$('#serverTime').text(date.toLocaleTimeString());\n\n\t\t\tdate.setHours(parseInt(hour, 10) - offset, 0, 0, 0);\n\n\t\t\t// If adjusted time is in the past, move to next day\n\t\t\tif (date.getTime() < Date.now()) {\n\t\t\t\tdate.setDate(date.getDate() + 1);\n\t\t\t}\n\n\t\t\t$('#nextDigestTime').text(date.toLocaleString());\n\t\t});\n\t}\n\n\tfunction handleSmtpServiceChange() {\n\t\tvar isCustom = $('[id=\"email:smtpTransport:service\"]').val() === 'nodebb-custom-smtp';\n\t\t$('[id=\"email:smtpTransport:custom-service\"]')[isCustom ? 'slideDown' : 'slideUp'](isCustom);\n\t}\n\n\treturn module;\n});\n"]}