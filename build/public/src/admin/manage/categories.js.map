{"version":3,"sources":["public/src/admin/manage/categories.js"],"names":["define","translator","Benchpress","categorySelector","api","Sortable","bootbox","Categories","newCategoryId","sortables","init","$","parentCid","ajaxify","data","selectedCategory","cid","onSelect","go","localCategories","render","categoriesTree","on","throwCreateModal","$this","this","attr","parentEl","parents","disabled","hasClass","childrenEls","find","childrenCids","map","get","toggle","concat","el","toggleClass","closest","order","modal","dialog","title","message","show","buttons","save","label","className","callback","val","modified","Math","max","parseInt","put","then","refresh","catch","err","app","alertError","toggleAll","expand","html","submit","options","name","icon","parentSelector","cloneFromSelector","formData","serializeObject","description","uid","user","getSelectedCid","cloneFromCid","create","check","parentSelect","prop","selectCategory","removeAttr","payload","post","alert","alert_id","type","timeout","categories","container","length","translate","text","addClass","appendTo","renderList","cids","listEl","document","querySelector","Promise","all","categoryEl","classList","first","translateText","itemDidAdd","e","to","dataset","itemDragDidEnd","isCategoryUpdate","newIndex","oldIndex","item","baseIndex","pagination","currentPage","categoriesPerPage","parentId","count","forEach","category","idx","parent","translated","continueRender","parseAndTranslate","append","x","numCategories","children","group","animation","handle","dataIdAttr","ghostClass","onAdd","onEnd"],"mappings":"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","file":"public/src/admin/manage/categories.js","sourcesContent":["'use strict';\n\ndefine('admin/manage/categories', [\n\t'translator',\n\t'benchpress',\n\t'categorySelector',\n\t'api',\n\t'Sortable',\n\t'bootbox',\n], function (translator, Benchpress, categorySelector, api, Sortable, bootbox) {\n\tvar\tCategories = {};\n\tvar newCategoryId = -1;\n\tvar sortables;\n\n\tCategories.init = function () {\n\t\tcategorySelector.init($('.category [component=\"category-selector\"]'), {\n\t\t\tparentCid: ajaxify.data.selectedCategory ? ajaxify.data.selectedCategory.cid : 0,\n\t\t\tonSelect: function (selectedCategory) {\n\t\t\t\tajaxify.go('/admin/manage/categories' + (selectedCategory.cid ? '?cid=' + selectedCategory.cid : ''));\n\t\t\t},\n\t\t\tlocalCategories: [],\n\t\t});\n\t\tCategories.render(ajaxify.data.categoriesTree);\n\n\t\t$('button[data-action=\"create\"]').on('click', Categories.throwCreateModal);\n\n\t\t// Enable/Disable toggle events\n\t\t$('.categories').on('click', '.category-tools [data-action=\"toggle\"]', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar cid = $this.attr('data-disable-cid');\n\t\t\tvar parentEl = $this.parents('li[data-cid=\"' + cid + '\"]');\n\t\t\tvar disabled = parentEl.hasClass('disabled');\n\t\t\tvar childrenEls = parentEl.find('li[data-cid]');\n\t\t\tvar childrenCids = childrenEls.map(function () {\n\t\t\t\treturn $(this).attr('data-cid');\n\t\t\t}).get();\n\n\t\t\tCategories.toggle([cid].concat(childrenCids), !disabled);\n\t\t});\n\n\t\t$('.categories').on('click', '.toggle', function () {\n\t\t\tvar el = $(this);\n\t\t\tel.find('i').toggleClass('fa-minus').toggleClass('fa-plus');\n\t\t\tel.closest('[data-cid]').find('> ul[data-cid]').toggleClass('hidden');\n\t\t});\n\n\t\t$('.categories').on('click', '.set-order', function () {\n\t\t\tvar cid = $(this).attr('data-cid');\n\t\t\tvar order = $(this).attr('data-order');\n\t\t\tvar modal = bootbox.dialog({\n\t\t\t\ttitle: '[[admin/manage/categories:set-order]]',\n\t\t\t\tmessage: '<input type=\"number\" min=\"1\" class=\"form-control input-lg\" value=' + order + ' /><p class=\"help-block\">[[admin/manage/categories:set-order-help]]</p>',\n\t\t\t\tshow: true,\n\t\t\t\tbuttons: {\n\t\t\t\t\tsave: {\n\t\t\t\t\t\tlabel: '[[modules:bootbox.confirm]]',\n\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\tcallback: function () {\n\t\t\t\t\t\t\tvar val = modal.find('input').val();\n\t\t\t\t\t\t\tif (val && cid) {\n\t\t\t\t\t\t\t\tvar modified = {};\n\t\t\t\t\t\t\t\tmodified[cid] = { order: Math.max(1, parseInt(val, 10)) };\n\t\t\t\t\t\t\t\tapi.put('/categories/' + cid, modified[cid]).then(function () {\n\t\t\t\t\t\t\t\t\tajaxify.refresh();\n\t\t\t\t\t\t\t\t}).catch(err => app.alertError(err));\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\n\t\t$('#collapse-all').on('click', function () {\n\t\t\ttoggleAll(false);\n\t\t});\n\n\t\t$('#expand-all').on('click', function () {\n\t\t\ttoggleAll(true);\n\t\t});\n\n\t\tfunction toggleAll(expand) {\n\t\t\tvar el = $('.categories .toggle');\n\t\t\tel.find('i').toggleClass('fa-minus', expand).toggleClass('fa-plus', !expand);\n\t\t\tel.closest('[data-cid]').find('> ul[data-cid]').toggleClass('hidden', !expand);\n\t\t}\n\t};\n\n\tCategories.throwCreateModal = function () {\n\t\tBenchpress.render('admin/partials/categories/create', {}).then(function (html) {\n\t\t\tvar modal = bootbox.dialog({\n\t\t\t\ttitle: '[[admin/manage/categories:alert.create]]',\n\t\t\t\tmessage: html,\n\t\t\t\tbuttons: {\n\t\t\t\t\tsave: {\n\t\t\t\t\t\tlabel: '[[global:save]]',\n\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\t\t\tvar options = {\n\t\t\t\tlocalCategories: [\n\t\t\t\t\t{\n\t\t\t\t\t\tcid: 0,\n\t\t\t\t\t\tname: '[[admin/manage/categories:parent-category-none]]',\n\t\t\t\t\t\ticon: 'fa-none',\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t};\n\t\t\tvar parentSelector = categorySelector.init(modal.find('#parentCidGroup [component=\"category-selector\"]'), options);\n\t\t\tvar cloneFromSelector = categorySelector.init(modal.find('#cloneFromCidGroup [component=\"category-selector\"]'), options);\n\t\t\tfunction submit() {\n\t\t\t\tvar formData = modal.find('form').serializeObject();\n\t\t\t\tformData.description = '';\n\t\t\t\tformData.icon = 'fa-comments';\n\t\t\t\tformData.uid = app.user.uid;\n\t\t\t\tformData.parentCid = parentSelector.getSelectedCid();\n\t\t\t\tformData.cloneFromCid = cloneFromSelector.getSelectedCid();\n\n\t\t\t\tCategories.create(formData);\n\t\t\t\tmodal.modal('hide');\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$('#cloneChildren').on('change', function () {\n\t\t\t\tvar check = $(this);\n\t\t\t\tvar parentSelect = modal.find('#parentCidGroup [component=\"category-selector\"] .dropdown-toggle');\n\n\t\t\t\tif (check.prop('checked')) {\n\t\t\t\t\tparentSelect.attr('disabled', 'disabled');\n\t\t\t\t\tparentSelector.selectCategory(0);\n\t\t\t\t} else {\n\t\t\t\t\tparentSelect.removeAttr('disabled');\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tmodal.find('form').on('submit', submit);\n\t\t});\n\t};\n\n\tCategories.create = function (payload) {\n\t\tapi.post('/categories', payload, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tapp.alert({\n\t\t\t\talert_id: 'category_created',\n\t\t\t\ttitle: '[[admin/manage/categories:alert.created]]',\n\t\t\t\tmessage: '[[admin/manage/categories:alert.create-success]]',\n\t\t\t\ttype: 'success',\n\t\t\t\ttimeout: 2000,\n\t\t\t});\n\n\t\t\tajaxify.go('admin/manage/categories/' + data.cid);\n\t\t});\n\t};\n\n\tCategories.render = function (categories) {\n\t\tvar container = $('.categories');\n\n\t\tif (!categories || !categories.length) {\n\t\t\ttranslator.translate('[[admin/manage/categories:alert.none-active]]', function (text) {\n\t\t\t\t$('<div></div>')\n\t\t\t\t\t.addClass('alert alert-info text-center')\n\t\t\t\t\t.text(text)\n\t\t\t\t\t.appendTo(container);\n\t\t\t});\n\t\t} else {\n\t\t\tsortables = {};\n\t\t\trenderList(categories, container, 0);\n\t\t}\n\t};\n\n\tCategories.toggle = function (cids, disabled) {\n\t\tconst listEl = document.querySelector('.categories ul');\n\t\tPromise.all(cids.map(cid => api.put('/categories/' + cid, {\n\t\t\tdisabled: disabled ? 1 : 0,\n\t\t}).then(() => {\n\t\t\tconst categoryEl = listEl.querySelector(`li[data-cid=\"${cid}\"]`);\n\t\t\tcategoryEl.classList[disabled ? 'add' : 'remove']('disabled');\n\t\t\t$(categoryEl).find('li a[data-action=\"toggle\"]').first().translateText(disabled ? '[[admin/manage/categories:enable]]' : '[[admin/manage/categories:disable]]');\n\t\t}).catch(app.alertError)));\n\t};\n\n\tfunction itemDidAdd(e) {\n\t\tnewCategoryId = e.to.dataset.cid;\n\t}\n\n\tfunction itemDragDidEnd(e) {\n\t\tvar isCategoryUpdate = parseInt(newCategoryId, 10) !== -1;\n\n\t\t// Update needed?\n\t\tif ((e.newIndex != null && parseInt(e.oldIndex, 10) !== parseInt(e.newIndex, 10)) || isCategoryUpdate) {\n\t\t\tvar cid = e.item.dataset.cid;\n\t\t\tvar modified = {};\n\t\t\t// on page 1 baseIndex is 0, on page n baseIndex is (n - 1) * ajaxify.data.categoriesPerPage\n\t\t\t// this makes sure order is correct when drag & drop is used on pages > 1\n\t\t\tvar baseIndex = (ajaxify.data.pagination.currentPage - 1) * ajaxify.data.categoriesPerPage;\n\t\t\tmodified[cid] = {\n\t\t\t\torder: baseIndex + e.newIndex + 1,\n\t\t\t};\n\n\t\t\tif (isCategoryUpdate) {\n\t\t\t\tmodified[cid].parentCid = newCategoryId;\n\t\t\t}\n\n\t\t\tnewCategoryId = -1;\n\t\t\tapi.put('/categories/' + cid, modified[cid]);\n\t\t}\n\t}\n\n\t/**\n\t * Render categories - recursively\n\t *\n\t * @param categories {array} categories tree\n\t * @param level {number} current sub-level of rendering\n\t * @param container {object} parent jquery element for the list\n\t * @param parentId {number} parent category identifier\n\t */\n\tfunction renderList(categories, container, parentId) {\n\t\t// Translate category names if needed\n\t\tvar count = 0;\n\t\tcategories.forEach(function (category, idx, parent) {\n\t\t\ttranslator.translate(category.name, function (translated) {\n\t\t\t\tif (category.name !== translated) {\n\t\t\t\t\tcategory.name = translated;\n\t\t\t\t}\n\t\t\t\tcount += 1;\n\n\t\t\t\tif (count === parent.length) {\n\t\t\t\t\tcontinueRender();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tif (!categories.length) {\n\t\t\tcontinueRender();\n\t\t}\n\n\t\tfunction continueRender() {\n\t\t\tapp.parseAndTranslate('admin/partials/categories/category-rows', {\n\t\t\t\tcid: parentId,\n\t\t\t\tcategories: categories,\n\t\t\t}, function (html) {\n\t\t\t\tcontainer.append(html);\n\n\t\t\t\t// Handle and children categories in this level have\n\t\t\t\tfor (var x = 0, numCategories = categories.length; x < numCategories; x += 1) {\n\t\t\t\t\trenderList(categories[x].children, $('li[data-cid=\"' + categories[x].cid + '\"]'), categories[x].cid);\n\t\t\t\t}\n\n\t\t\t\t// Make list sortable\n\t\t\t\tsortables[parentId] = Sortable.create($('ul[data-cid=\"' + parentId + '\"]')[0], {\n\t\t\t\t\tgroup: 'cross-categories',\n\t\t\t\t\tanimation: 150,\n\t\t\t\t\thandle: '.information',\n\t\t\t\t\tdataIdAttr: 'data-cid',\n\t\t\t\t\tghostClass: 'placeholder',\n\t\t\t\t\tonAdd: itemDidAdd,\n\t\t\t\t\tonEnd: itemDragDidEnd,\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\treturn Categories;\n});\n"]}