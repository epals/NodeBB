{"version":3,"sources":["public/src/admin/manage/users.js"],"names":["define","translator","Benchpress","autocomplete","api","slugify","bootbox","AccountInvite","Users","init","$","val","ajaxify","data","resultsPerPage","on","query","utils","params","qs","buildSearchQuery","go","window","location","pathname","socket","once","app","removeAlert","alert","alert_id","type","title","message","clickfn","href","config","relative_path","timeout","emit","err","alertError","userCount","getSelectedUids","uids","each","this","is","push","attr","update","className","state","parents","find","toggleClass","unselectAll","prop","removeRow","uid","checkboxEl","document","querySelector","rowEl","closest","parentNode","removeChild","done","successMessage","flag","alertSuccess","onSuccess","length","render","then","html","modal","dialog","onEscape","group","ev","ui","target","put","item","slug","undefined","nameEscaped","escape","displayName","parseAndTranslate","users","groups","append","catch","groupCard","groupName","del","remove","confirm","Promise","all","map","show","buttons","close","label","submit","callback","formData","serializeArray","reduce","cur","name","value","until","Date","now","parseInt","unit","reason","handleDelete","confirmMsg","path","refresh","handleUserCreate","cancel","create","createUser","call","focus","username","getElementById","email","password","passwordAgain","errorEl","translateHtml","removeClass","user","post","status","handleSearch","handleSort","handleFilter","handle","timeoutId","doSearch","loadSearchPage","searchBy","page","clearTimeout","setTimeout","sortBy","decodeURIComponent","param","get","renderSearchResults","fail","xhrErr","responseJSON","error","pagination","replaceWith","timeago","addClass","compile","matchCount","timing","$this","sortDirection","reverse","getFilters","filters","currentFilters","hasClass","changed","forEach","filter","i"],"mappings":"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","file":"public/src/admin/manage/users.js","sourcesContent":["'use strict';\n\ndefine('admin/manage/users', [\n\t'translator', 'benchpress', 'autocomplete', 'api', 'slugify', 'bootbox', 'accounts/invite',\n], function (translator, Benchpress, autocomplete, api, slugify, bootbox, AccountInvite) {\n\tvar Users = {};\n\n\tUsers.init = function () {\n\t\t$('#results-per-page').val(ajaxify.data.resultsPerPage).on('change', function () {\n\t\t\tvar query = utils.params();\n\t\t\tquery.resultsPerPage = $('#results-per-page').val();\n\t\t\tvar qs = buildSearchQuery(query);\n\t\t\tajaxify.go(window.location.pathname + '?' + qs);\n\t\t});\n\n\t\t$('.export-csv').on('click', function () {\n\t\t\tsocket.once('event:export-users-csv', function () {\n\t\t\t\tapp.removeAlert('export-users-start');\n\t\t\t\tapp.alert({\n\t\t\t\t\talert_id: 'export-users',\n\t\t\t\t\ttype: 'success',\n\t\t\t\t\ttitle: '[[global:alert.success]]',\n\t\t\t\t\tmessage: '[[admin/manage/users:export-users-completed]]',\n\t\t\t\t\tclickfn: function () {\n\t\t\t\t\t\twindow.location.href = config.relative_path + '/api/admin/users/csv';\n\t\t\t\t\t},\n\t\t\t\t\ttimeout: 0,\n\t\t\t\t});\n\t\t\t});\n\t\t\tsocket.emit('admin.user.exportUsersCSV', {}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tapp.alert({\n\t\t\t\t\talert_id: 'export-users-start',\n\t\t\t\t\tmessage: '[[admin/manage/users:export-users-started]]',\n\t\t\t\t\ttimeout: (ajaxify.data.userCount / 5000) * 500,\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn false;\n\t\t});\n\n\t\tfunction getSelectedUids() {\n\t\t\tvar uids = [];\n\n\t\t\t$('.users-table [component=\"user/select/single\"]').each(function () {\n\t\t\t\tif ($(this).is(':checked')) {\n\t\t\t\t\tuids.push($(this).attr('data-uid'));\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn uids;\n\t\t}\n\n\t\tfunction update(className, state) {\n\t\t\t$('.users-table [component=\"user/select/single\"]:checked').parents('.user-row').find(className).each(function () {\n\t\t\t\t$(this).toggleClass('hidden', !state);\n\t\t\t});\n\t\t}\n\n\t\tfunction unselectAll() {\n\t\t\t$('.users-table [component=\"user/select/single\"]').prop('checked', false);\n\t\t\t$('.users-table [component=\"user/select/all\"]').prop('checked', false);\n\t\t}\n\n\t\tfunction removeRow(uid) {\n\t\t\tconst checkboxEl = document.querySelector(`.users-table [component=\"user/select/single\"][data-uid=\"${uid}\"]`);\n\t\t\tif (checkboxEl) {\n\t\t\t\tconst rowEl = checkboxEl.closest('.user-row');\n\t\t\t\trowEl.parentNode.removeChild(rowEl);\n\t\t\t}\n\t\t}\n\n\t\t// use onSuccess instead\n\t\tfunction done(successMessage, className, flag) {\n\t\t\treturn function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tapp.alertSuccess(successMessage);\n\t\t\t\tif (className) {\n\t\t\t\t\tupdate(className, flag);\n\t\t\t\t}\n\t\t\t\tunselectAll();\n\t\t\t};\n\t\t}\n\n\t\tfunction onSuccess(successMessage, className, flag) {\n\t\t\tapp.alertSuccess(successMessage);\n\t\t\tif (className) {\n\t\t\t\tupdate(className, flag);\n\t\t\t}\n\t\t\tunselectAll();\n\t\t}\n\n\t\t$('[component=\"user/select/all\"]').on('click', function () {\n\t\t\t$('.users-table [component=\"user/select/single\"]').prop('checked', $(this).is(':checked'));\n\t\t});\n\n\t\t$('.manage-groups').on('click', function () {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\tapp.alertError('[[error:no-users-selected]]');\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tsocket.emit('admin.user.loadGroups', uids, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tBenchpress.render('admin/partials/manage_user_groups', data).then(function (html) {\n\t\t\t\t\tvar modal = bootbox.dialog({\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\ttitle: '[[admin/manage/users:manage-groups]]',\n\t\t\t\t\t\tonEscape: true,\n\t\t\t\t\t});\n\t\t\t\t\tmodal.on('shown.bs.modal', function () {\n\t\t\t\t\t\tautocomplete.group(modal.find('.group-search'), function (ev, ui) {\n\t\t\t\t\t\t\tvar uid = $(ev.target).attr('data-uid');\n\t\t\t\t\t\t\tapi.put('/groups/' + ui.item.group.slug + '/membership/' + uid, undefined).then(() => {\n\t\t\t\t\t\t\t\tui.item.group.nameEscaped = translator.escape(ui.item.group.displayName);\n\t\t\t\t\t\t\t\tapp.parseAndTranslate('admin/partials/manage_user_groups', { users: [{ groups: [ui.item.group] }] }, function (html) {\n\t\t\t\t\t\t\t\t\t$('[data-uid=' + uid + '] .group-area').append(html.find('.group-area').html());\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}).catch(app.alertError);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tmodal.on('click', '.group-area a', function () {\n\t\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t\t});\n\t\t\t\t\tmodal.on('click', '.remove-group-icon', function () {\n\t\t\t\t\t\tvar groupCard = $(this).parents('[data-group-name]');\n\t\t\t\t\t\tvar groupName = groupCard.attr('data-group-name');\n\t\t\t\t\t\tvar uid = $(this).parents('[data-uid]').attr('data-uid');\n\t\t\t\t\t\tapi.del('/groups/' + slugify(groupName) + '/membership/' + uid).then(() => {\n\t\t\t\t\t\t\tgroupCard.remove();\n\t\t\t\t\t\t}).catch(app.alertError);\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\t$('.ban-user').on('click', function () {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\tapp.alertError('[[error:no-users-selected]]');\n\t\t\t\treturn false;\t// specifically to keep the menu open\n\t\t\t}\n\n\t\t\tbootbox.confirm((uids.length > 1 ? '[[admin/manage/users:alerts.confirm-ban-multi]]' : '[[admin/manage/users:alerts.confirm-ban]]'), function (confirm) {\n\t\t\t\tif (confirm) {\n\t\t\t\t\tPromise.all(uids.map(function (uid) {\n\t\t\t\t\t\treturn api.put('/users/' + uid + '/ban');\n\t\t\t\t\t})).then(() => {\n\t\t\t\t\t\tonSuccess('[[admin/manage/users:alerts.ban-success]]', '.ban', true);\n\t\t\t\t\t}).catch(app.alertError);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t$('.ban-user-temporary').on('click', function () {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\tapp.alertError('[[error:no-users-selected]]');\n\t\t\t\treturn false;\t// specifically to keep the menu open\n\t\t\t}\n\n\t\t\tBenchpress.render('admin/partials/temporary-ban', {}).then(function (html) {\n\t\t\t\tbootbox.dialog({\n\t\t\t\t\tclassName: 'ban-modal',\n\t\t\t\t\ttitle: '[[user:ban_account]]',\n\t\t\t\t\tmessage: html,\n\t\t\t\t\tshow: true,\n\t\t\t\t\tbuttons: {\n\t\t\t\t\t\tclose: {\n\t\t\t\t\t\t\tlabel: '[[global:close]]',\n\t\t\t\t\t\t\tclassName: 'btn-link',\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsubmit: {\n\t\t\t\t\t\t\tlabel: '[[admin/manage/users:alerts.button-ban-x, ' + uids.length + ']]',\n\t\t\t\t\t\t\tcallback: function () {\n\t\t\t\t\t\t\t\tvar formData = $('.ban-modal form').serializeArray().reduce(function (data, cur) {\n\t\t\t\t\t\t\t\t\tdata[cur.name] = cur.value;\n\t\t\t\t\t\t\t\t\treturn data;\n\t\t\t\t\t\t\t\t}, {});\n\t\t\t\t\t\t\t\tvar until = formData.length > 0 ? (\n\t\t\t\t\t\t\t\t\tDate.now() + (formData.length * 1000 * 60 * 60 * (parseInt(formData.unit, 10) ? 24 : 1))\n\t\t\t\t\t\t\t\t) : 0;\n\n\t\t\t\t\t\t\t\tPromise.all(uids.map(function (uid) {\n\t\t\t\t\t\t\t\t\treturn api.put('/users/' + uid + '/ban', {\n\t\t\t\t\t\t\t\t\t\tuntil: until,\n\t\t\t\t\t\t\t\t\t\treason: formData.reason,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t})).then(() => {\n\t\t\t\t\t\t\t\t\tonSuccess('[[admin/manage/users:alerts.ban-success]]', '.ban', true);\n\t\t\t\t\t\t\t\t}).catch(app.alertError);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\t$('.unban-user').on('click', function () {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\tapp.alertError('[[error:no-users-selected]]');\n\t\t\t\treturn false;\t// specifically to keep the menu open\n\t\t\t}\n\n\t\t\tPromise.all(uids.map(function (uid) {\n\t\t\t\treturn api.del('/users/' + uid + '/ban');\n\t\t\t})).then(() => {\n\t\t\t\tonSuccess('[[admin/manage/users:alerts.unban-success]]', '.ban', false);\n\t\t\t});\n\t\t});\n\n\t\t$('.reset-lockout').on('click', function () {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsocket.emit('admin.user.resetLockouts', uids, done('[[admin/manage/users:alerts.lockout-reset-success]]'));\n\t\t});\n\n\t\t$('.validate-email').on('click', function () {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tbootbox.confirm('[[admin/manage/users:alerts.confirm-validate-email]]', function (confirm) {\n\t\t\t\tif (!confirm) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tsocket.emit('admin.user.validateEmail', uids, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tapp.alertSuccess('[[admin/manage/users:alerts.validate-email-success]]');\n\t\t\t\t\tupdate('.notvalidated', false);\n\t\t\t\t\tupdate('.validated', true);\n\t\t\t\t\tunselectAll();\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\t$('.send-validation-email').on('click', function () {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('admin.user.sendValidationEmail', uids, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tapp.alertSuccess('[[notifications:email-confirm-sent]]');\n\t\t\t});\n\t\t});\n\n\t\t$('.password-reset-email').on('click', function () {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tbootbox.confirm('[[admin/manage/users:alerts.password-reset-confirm]]', function (confirm) {\n\t\t\t\tif (confirm) {\n\t\t\t\t\tsocket.emit('admin.user.sendPasswordResetEmail', uids, done('[[notifications:email-confirm-sent]]'));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t$('.force-password-reset').on('click', function () {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tbootbox.confirm('[[admin/manage/users:alerts.confirm-force-password-reset]]', function (confirm) {\n\t\t\t\tif (confirm) {\n\t\t\t\t\tsocket.emit('admin.user.forcePasswordReset', uids, done('[[admin/manage/users:alerts.validate-force-password-reset-success]]'));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t$('.delete-user').on('click', () => {\n\t\t\thandleDelete('[[admin/manage/users:alerts.confirm-delete]]', '/account');\n\t\t});\n\n\t\t$('.delete-user-content').on('click', () => {\n\t\t\thandleDelete('[[admin/manage/users:alerts.confirm-delete-content]]', '/content');\n\t\t});\n\n\t\t$('.delete-user-and-content').on('click', () => {\n\t\t\thandleDelete('[[admin/manage/users:alerts.confirm-purge]]', '');\n\t\t});\n\n\t\tfunction handleDelete(confirmMsg, path) {\n\t\t\tvar uids = getSelectedUids();\n\t\t\tif (!uids.length) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tbootbox.confirm(confirmMsg, function (confirm) {\n\t\t\t\tif (confirm) {\n\t\t\t\t\tPromise.all(\n\t\t\t\t\t\tuids.map(\n\t\t\t\t\t\t\tuid => api.del(`/users/${uid}${path}`, {}).then(() => {\n\t\t\t\t\t\t\t\tif (path !== '/content') {\n\t\t\t\t\t\t\t\t\tremoveRow(uid);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t)\n\t\t\t\t\t).then(() => {\n\t\t\t\t\t\tif (path !== '/content') {\n\t\t\t\t\t\t\tapp.alertSuccess('[[admin/manage/users:alerts.delete-success]]');\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tapp.alertSuccess('[[admin/manage/users:alerts.delete-content-success]]');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tunselectAll();\n\t\t\t\t\t\tif (!$('.users-table [component=\"user/select/single\"]').length) {\n\t\t\t\t\t\t\tajaxify.refresh();\n\t\t\t\t\t\t}\n\t\t\t\t\t}).catch(app.alertError);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tfunction handleUserCreate() {\n\t\t\t$('[data-action=\"create\"]').on('click', function () {\n\t\t\t\tBenchpress.render('admin/partials/create_user_modal', {}).then(function (html) {\n\t\t\t\t\tvar modal = bootbox.dialog({\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\ttitle: '[[admin/manage/users:alerts.create]]',\n\t\t\t\t\t\tonEscape: true,\n\t\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\tcancel: {\n\t\t\t\t\t\t\t\tlabel: '[[admin/manage/users:alerts.button-cancel]]',\n\t\t\t\t\t\t\t\tclassName: 'btn-link',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tcreate: {\n\t\t\t\t\t\t\t\tlabel: '[[admin/manage/users:alerts.button-create]]',\n\t\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\t\tcallback: function () {\n\t\t\t\t\t\t\t\t\tcreateUser.call(this);\n\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tmodal.on('shown.bs.modal', function () {\n\t\t\t\t\t\tmodal.find('#create-user-name').focus();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\treturn false;\n\t\t\t});\n\t\t}\n\n\t\tfunction createUser() {\n\t\t\tvar modal = this;\n\t\t\tvar username = document.getElementById('create-user-name').value;\n\t\t\tvar email = document.getElementById('create-user-email').value;\n\t\t\tvar password = document.getElementById('create-user-password').value;\n\t\t\tvar passwordAgain = document.getElementById('create-user-password-again').value;\n\n\t\t\tvar errorEl = $('#create-modal-error');\n\n\t\t\tif (password !== passwordAgain) {\n\t\t\t\treturn errorEl.translateHtml('[[admin/manage/users:alerts.error-x, [[admin/manage/users:alerts.error-passwords-different]]]]').removeClass('hide');\n\t\t\t}\n\n\t\t\tvar user = {\n\t\t\t\tusername: username,\n\t\t\t\temail: email,\n\t\t\t\tpassword: password,\n\t\t\t};\n\n\t\t\tapi.post('/users', user)\n\t\t\t\t.then(() => {\n\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t\tmodal.on('hidden.bs.modal', function () {\n\t\t\t\t\t\tajaxify.refresh();\n\t\t\t\t\t});\n\t\t\t\t\tapp.alertSuccess('[[admin/manage/users:alerts.create-success]]');\n\t\t\t\t})\n\t\t\t\t.catch(err => errorEl.translateHtml('[[admin/manage/users:alerts.error-x, ' + err.status.message + ']]').removeClass('hidden'));\n\t\t}\n\n\t\thandleSearch();\n\t\thandleUserCreate();\n\t\thandleSort();\n\t\thandleFilter();\n\t\tAccountInvite.handle();\n\t};\n\n\tfunction handleSearch() {\n\t\tvar timeoutId = 0;\n\t\tfunction doSearch() {\n\t\t\t$('.fa-spinner').removeClass('hidden');\n\t\t\tloadSearchPage({\n\t\t\t\tsearchBy: $('#user-search-by').val(),\n\t\t\t\tquery: $('#user-search').val(),\n\t\t\t\tpage: 1,\n\t\t\t});\n\t\t}\n\t\t$('#user-search').on('keyup', function () {\n\t\t\tif (timeoutId !== 0) {\n\t\t\t\tclearTimeout(timeoutId);\n\t\t\t\ttimeoutId = 0;\n\t\t\t}\n\t\t\ttimeoutId = setTimeout(doSearch, 250);\n\t\t});\n\t\t$('#user-search-by').on('change', function () {\n\t\t\tdoSearch();\n\t\t});\n\t}\n\n\tfunction loadSearchPage(query) {\n\t\tvar params = utils.params();\n\t\tparams.searchBy = query.searchBy;\n\t\tparams.query = query.query;\n\t\tparams.page = query.page;\n\t\tparams.sortBy = params.sortBy || 'lastonline';\n\t\tvar qs = decodeURIComponent($.param(params));\n\t\t$.get(config.relative_path + '/api/admin/manage/users?' + qs, renderSearchResults).fail(function (xhrErr) {\n\t\t\tif (xhrErr && xhrErr.responseJSON && xhrErr.responseJSON.error) {\n\t\t\t\tapp.alertError(xhrErr.responseJSON.error);\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction renderSearchResults(data) {\n\t\tBenchpress.render('partials/paginator', { pagination: data.pagination }).then(function (html) {\n\t\t\t$('.pagination-container').replaceWith(html);\n\t\t});\n\n\t\tapp.parseAndTranslate('admin/manage/users', 'users', data, function (html) {\n\t\t\t$('.users-table tbody tr').remove();\n\t\t\t$('.users-table tbody').append(html);\n\t\t\thtml.find('.timeago').timeago();\n\t\t\t$('.fa-spinner').addClass('hidden');\n\t\t\tif (!$('#user-search').val()) {\n\t\t\t\t$('#user-found-notify').addClass('hidden');\n\t\t\t\t$('#user-notfound-notify').addClass('hidden');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (data && data.users.length === 0) {\n\t\t\t\t$('#user-notfound-notify').translateHtml('[[admin/manage/users:search.not-found]]')\n\t\t\t\t\t.removeClass('hidden');\n\t\t\t\t$('#user-found-notify').addClass('hidden');\n\t\t\t} else {\n\t\t\t\t$('#user-found-notify').translateHtml(\n\t\t\t\t\ttranslator.compile('admin/manage/users:alerts.x-users-found', data.matchCount, data.timing)\n\t\t\t\t).removeClass('hidden');\n\t\t\t\t$('#user-notfound-notify').addClass('hidden');\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction buildSearchQuery(params) {\n\t\tif ($('#user-search').val()) {\n\t\t\tparams.query = $('#user-search').val();\n\t\t\tparams.searchBy = $('#user-search-by').val();\n\t\t} else {\n\t\t\tdelete params.query;\n\t\t\tdelete params.searchBy;\n\t\t}\n\n\t\treturn decodeURIComponent($.param(params));\n\t}\n\n\tfunction handleSort() {\n\t\t$('.users-table thead th').on('click', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar sortBy = $this.attr('data-sort');\n\t\t\tif (!sortBy) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar params = utils.params();\n\t\t\tparams.sortBy = sortBy;\n\t\t\tif (ajaxify.data.sortBy === sortBy) {\n\t\t\t\tparams.sortDirection = ajaxify.data.reverse ? 'asc' : 'desc';\n\t\t\t} else {\n\t\t\t\tparams.sortDirection = 'desc';\n\t\t\t}\n\n\t\t\tvar qs = buildSearchQuery(params);\n\t\t\tajaxify.go('admin/manage/users?' + qs);\n\t\t});\n\t}\n\n\tfunction getFilters() {\n\t\tvar filters = [];\n\t\t$('#filter-by').find('[data-filter-by]').each(function () {\n\t\t\tif ($(this).find('.fa-check').length) {\n\t\t\t\tfilters.push($(this).attr('data-filter-by'));\n\t\t\t}\n\t\t});\n\t\treturn filters;\n\t}\n\n\tfunction handleFilter() {\n\t\tvar currentFilters = getFilters();\n\t\t$('#filter-by').on('click', 'li', function () {\n\t\t\tvar $this = $(this);\n\t\t\t$this.find('i').toggleClass('fa-check', !$this.find('i').hasClass('fa-check'));\n\t\t\treturn false;\n\t\t});\n\n\t\t$('#filter-by').on('hidden.bs.dropdown', function () {\n\t\t\tvar filters = getFilters();\n\t\t\tvar changed = filters.length !== currentFilters.length;\n\t\t\tif (filters.length === currentFilters.length) {\n\t\t\t\tfilters.forEach(function (filter, i) {\n\t\t\t\t\tif (filter !== currentFilters[i]) {\n\t\t\t\t\t\tchanged = true;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\tcurrentFilters = getFilters();\n\t\t\tif (changed) {\n\t\t\t\tvar params = utils.params();\n\t\t\t\tparams.filters = filters;\n\t\t\t\tvar qs = buildSearchQuery(params);\n\t\t\t\tajaxify.go('admin/manage/users?' + qs);\n\t\t\t}\n\t\t});\n\t}\n\n\treturn Users;\n});\n"]}