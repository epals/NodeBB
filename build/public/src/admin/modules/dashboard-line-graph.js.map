{"version":3,"sources":["public/src/admin/modules/dashboard-line-graph.js"],"names":["define","Chart","translator","Benchpress","api","hooks","Graph","_current","isMobile","init","set","dataset","canvas","document","getElementById","canvasCtx","getContext","trafficLabels","utils","getHoursArray","test","navigator","userAgent","defaults","global","tooltips","enabled","handleUpdateControls","t","Translator","create","Promise","resolve","translateKey","ajaxify","data","template","name","replace","then","key","labels","datasets","label","backgroundColor","borderColor","pointBackgroundColor","pointHoverBackgroundColor","pointBorderColor","pointHoverBorderColor","width","$","parent","yAxisID","type","options","responsive","legend","display","scales","yAxes","id","ticks","beginAtZero","precision","position","scaleLabel","labelString","mode","update","on","until","Date","amount","this","attr","setHours","getTime","require","translate","translated","text","targetEl","render","html","modal","bootbox","dialog","title","message","buttons","submit","className","callback","date","today","toISOString","substr","setDate","getDate","yesterday","find","val","formData","serializeObject","validRegexp","startRange","endRange","removeClass","units","query","count","reject","Error","get","xLabels","getDaysArray","apiEl","newHref","param","config","relative_path","updateHistory","url","slice","fire","graph"],"mappings":"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","file":"public/src/admin/modules/dashboard-line-graph.js","sourcesContent":["'use strict';\n\ndefine('admin/modules/dashboard-line-graph', ['Chart', 'translator', 'benchpress', 'api', 'hooks'], function (Chart, translator, Benchpress, api, hooks) {\n\tconst Graph = {\n\t\t_current: null,\n\t};\n\tlet isMobile = false;\n\n\tGraph.init = ({ set, dataset }) => {\n\t\tconst canvas = document.getElementById('analytics-traffic');\n\t\tconst canvasCtx = canvas.getContext('2d');\n\t\tconst trafficLabels = utils.getHoursArray();\n\n\t\tisMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\n\t\tif (isMobile) {\n\t\t\tChart.defaults.global.tooltips.enabled = false;\n\t\t}\n\n\t\tGraph.handleUpdateControls({ set });\n\n\t\tvar t = translator.Translator.create();\n\t\treturn new Promise((resolve) => {\n\t\t\tt.translateKey(`admin/menu:${ajaxify.data.template.name.replace('admin/', '')}`, []).then((key) => {\n\t\t\t\tconst data = {\n\t\t\t\t\tlabels: trafficLabels,\n\t\t\t\t\tdatasets: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: key,\n\t\t\t\t\t\t\tbackgroundColor: 'rgba(151,187,205,0.2)',\n\t\t\t\t\t\t\tborderColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\t\tpointBackgroundColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\t\tpointHoverBackgroundColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\t\tpointBorderColor: '#fff',\n\t\t\t\t\t\t\tpointHoverBorderColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\t\tdata: dataset || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t};\n\n\t\t\t\tcanvas.width = $(canvas).parent().width();\n\n\t\t\t\tdata.datasets[0].yAxisID = 'left-y-axis';\n\n\t\t\t\tGraph._current = new Chart(canvasCtx, {\n\t\t\t\t\ttype: 'line',\n\t\t\t\t\tdata: data,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tresponsive: true,\n\t\t\t\t\t\tlegend: {\n\t\t\t\t\t\t\tdisplay: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tscales: {\n\t\t\t\t\t\t\tyAxes: [{\n\t\t\t\t\t\t\t\tid: 'left-y-axis',\n\t\t\t\t\t\t\t\tticks: {\n\t\t\t\t\t\t\t\t\tbeginAtZero: true,\n\t\t\t\t\t\t\t\t\tprecision: 0,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\ttype: 'linear',\n\t\t\t\t\t\t\t\tposition: 'left',\n\t\t\t\t\t\t\t\tscaleLabel: {\n\t\t\t\t\t\t\t\t\tdisplay: true,\n\t\t\t\t\t\t\t\t\tlabelString: key,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}],\n\t\t\t\t\t\t},\n\t\t\t\t\t\ttooltips: {\n\t\t\t\t\t\t\tmode: 'x',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\tif (!dataset) {\n\t\t\t\t\tGraph.update(set).then(resolve);\n\t\t\t\t} else {\n\t\t\t\t\tresolve(Graph._current);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tGraph.handleUpdateControls = ({ set }) => {\n\t\t$('[data-action=\"updateGraph\"]:not([data-units=\"custom\"])').on('click', function () {\n\t\t\tvar until = new Date();\n\t\t\tvar amount = $(this).attr('data-amount');\n\t\t\tif ($(this).attr('data-units') === 'days') {\n\t\t\t\tuntil.setHours(0, 0, 0, 0);\n\t\t\t}\n\t\t\tuntil = until.getTime();\n\t\t\tGraph.update(set, $(this).attr('data-units'), until, amount);\n\n\t\t\trequire(['translator'], function (translator) {\n\t\t\t\ttranslator.translate('[[admin/dashboard:page-views-custom]]', function (translated) {\n\t\t\t\t\t$('[data-action=\"updateGraph\"][data-units=\"custom\"]').text(translated);\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\t$('[data-action=\"updateGraph\"][data-units=\"custom\"]').on('click', function () {\n\t\t\tvar targetEl = $(this);\n\n\t\t\tBenchpress.render('admin/partials/pageviews-range-select', {}).then(function (html) {\n\t\t\t\tvar modal = bootbox.dialog({\n\t\t\t\t\ttitle: '[[admin/dashboard:page-views-custom]]',\n\t\t\t\t\tmessage: html,\n\t\t\t\t\tbuttons: {\n\t\t\t\t\t\tsubmit: {\n\t\t\t\t\t\t\tlabel: '[[global:search]]',\n\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t}).on('shown.bs.modal', function () {\n\t\t\t\t\tvar date = new Date();\n\t\t\t\t\tvar today = date.toISOString().substr(0, 10);\n\t\t\t\t\tdate.setDate(date.getDate() - 1);\n\t\t\t\t\tvar yesterday = date.toISOString().substr(0, 10);\n\n\t\t\t\t\tmodal.find('#startRange').val(targetEl.attr('data-startRange') || yesterday);\n\t\t\t\t\tmodal.find('#endRange').val(targetEl.attr('data-endRange') || today);\n\t\t\t\t});\n\n\t\t\t\tfunction submit() {\n\t\t\t\t\t// NEED TO ADD VALIDATION HERE FOR YYYY-MM-DD\n\t\t\t\t\tvar formData = modal.find('form').serializeObject();\n\t\t\t\t\tvar validRegexp = /\\d{4}-\\d{2}-\\d{2}/;\n\n\t\t\t\t\t// Input validation\n\t\t\t\t\tif (!formData.startRange && !formData.endRange) {\n\t\t\t\t\t\t// No range? Assume last 30 days\n\t\t\t\t\t\tGraph.update(set, 'days');\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} else if (!validRegexp.test(formData.startRange) || !validRegexp.test(formData.endRange)) {\n\t\t\t\t\t\t// Invalid Input\n\t\t\t\t\t\tmodal.find('.alert-danger').removeClass('hidden');\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar until = new Date(formData.endRange);\n\t\t\t\t\tuntil.setDate(until.getDate() + 1);\n\t\t\t\t\tuntil = until.getTime();\n\t\t\t\t\tvar amount = (until - new Date(formData.startRange).getTime()) / (1000 * 60 * 60 * 24);\n\n\t\t\t\t\tGraph.update(set, 'days', until, amount);\n\n\t\t\t\t\t// Update \"custom range\" label\n\t\t\t\t\ttargetEl.attr('data-startRange', formData.startRange);\n\t\t\t\t\ttargetEl.attr('data-endRange', formData.endRange);\n\t\t\t\t\ttargetEl.html(formData.startRange + ' &ndash; ' + formData.endRange);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tGraph.update = (\n\t\tset,\n\t\tunits = ajaxify.data.query.units || 'hours',\n\t\tuntil = ajaxify.data.query.until,\n\t\tamount = ajaxify.data.query.count\n\t) => {\n\t\tif (!Graph._current) {\n\t\t\treturn Promise.reject(new Error('[[error:invalid-data]]'));\n\t\t}\n\n\t\treturn new Promise((resolve) => {\n\t\t\tapi.get(`/admin/analytics/${set}`, { units, until, amount }).then((dataset) => {\n\t\t\t\tif (units === 'days') {\n\t\t\t\t\tGraph._current.data.xLabels = utils.getDaysArray(until, amount);\n\t\t\t\t} else {\n\t\t\t\t\tGraph._current.data.xLabels = utils.getHoursArray();\n\t\t\t\t}\n\n\t\t\t\tGraph._current.data.datasets[0].data = dataset;\n\t\t\t\tGraph._current.data.labels = Graph._current.data.xLabels;\n\t\t\t\tGraph._current.update();\n\n\t\t\t\t// Update address bar and \"View as JSON\" button url\n\t\t\t\tvar apiEl = $('#view-as-json');\n\t\t\t\tvar newHref = $.param({\n\t\t\t\t\tunits: units || 'hours',\n\t\t\t\t\tuntil: until,\n\t\t\t\t\tcount: amount,\n\t\t\t\t});\n\t\t\t\tapiEl.attr('href', `${config.relative_path}/api/v3/admin/analytics/${ajaxify.data.set}?${newHref}`);\n\t\t\t\tajaxify.updateHistory(`${ajaxify.data.url.slice(1)}?${newHref}`, true);\n\t\t\t\thooks.fire('action:admin.dashboard.updateGraph', {\n\t\t\t\t\tgraph: Graph._current,\n\t\t\t\t});\n\t\t\t\tresolve(Graph._current);\n\t\t\t});\n\t\t});\n\t};\n\n\treturn Graph;\n});\n"]}