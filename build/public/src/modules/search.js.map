{"version":3,"sources":["public/src/modules/search.js"],"names":["define","nav","translator","storage","Search","current","query","data","callback","topicSearch","term","match","ajaxify","go","createQueryString","cleanedTerm","replace","tid","length","queryTopic","api","apiURL","config","relative_path","searchOnly","undefined","searchURL","$","get","result","url","searchIn","in","postedBy","by","encodeURIComponent","e","app","alertError","matchWords","categories","searchChildren","hasTags","parseInt","replies","repliesFilter","timeRange","timeFilter","sortBy","sortDirection","showAs","window","trigger","decodeURIComponent","param","getSearchPreferences","JSON","parse","getItem","highlightMatches","searchQuery","els","utils","escapeHTML","trim","regexStr","split","map","word","escapeRegexChars","join","regex","RegExp","each","this","nested","find","after","push","append","html","p1","forEach","nestedEl","i","addClass","socket","emit","err","pids","message","Array","isArray","results","sort","a","b","checkPagePresence","topicDOM","update","active","prev","index","next","topicSearchEl","start","removeAttr","pid","topicPostSort","postIndex","scrollToIndex","translate","text","removeClass","attr","require","mousetrap","bind","end","unbind"],"mappings":"AAAA,aAGAA,OAAO,UAAW,YAAa,aAAc,WAAY,SAAUC,EAAKC,EAAYC,GACnF,IAAIC,GACHC,YAGDD,EAAOE,MAAQ,SAAUC,EAAMC,GAE9B,IAAIC,EAAcF,EAAKG,KAAKC,MAAM,sBAClCH,EAAWA,GAAY,aACvB,IAAKC,EAAa,CACjBG,QAAQC,GAAG,UAAYC,EAAkBP,IACzCC,QACM,CACN,IAAIO,EAAcR,EAAKG,KAAKM,QAAQP,EAAY,GAAI,IACpD,IAAIQ,EAAMR,EAAY,GAEtB,GAAIM,EAAYG,OAAS,EAAG,CAC3Bd,EAAOe,WAAWF,EAAKF,EAAaP,MAKvCJ,EAAOgB,IAAM,SAAUb,EAAMC,GAC5B,IAAIa,EAASC,OAAOC,cAAgB,eAAiBT,EAAkBP,GACvEA,EAAKiB,WAAaC,UAClB,IAAIC,EAAYJ,OAAOC,cAAgB,WAAaT,EAAkBP,GACtEoB,EAAEC,IAAIP,EAAQ,SAAUQ,GACvBA,EAAOC,IAAMJ,EACblB,EAASqB,MAIX,SAASf,EAAkBP,GAC1B,IAAIwB,EAAWxB,EAAKyB,IAAM,SAC1B,IAAIC,EAAW1B,EAAK2B,IAAM,GAC1B,IAAIxB,EAAOH,EAAKG,KAAKM,QAAQ,UAAW,IACxC,IACCN,EAAOyB,mBAAmBzB,GACzB,MAAO0B,GACR,OAAOC,IAAIC,WAAW,iCAGvB,IAAIhC,GACHI,KAAMA,EACNsB,GAAID,GAGL,GAAIxB,EAAKgC,WAAY,CACpBjC,EAAMiC,WAAahC,EAAKgC,WAGzB,GAAIN,GAAYA,EAASf,SAAWa,IAAa,SAAWA,IAAa,UAAYA,IAAa,eAAgB,CACjHzB,EAAM4B,GAAKD,EAGZ,GAAI1B,EAAKiC,YAAcjC,EAAKiC,WAAWtB,OAAQ,CAC9CZ,EAAMkC,WAAajC,EAAKiC,WACxB,GAAIjC,EAAKkC,eAAgB,CACxBnC,EAAMmC,eAAiBlC,EAAKkC,gBAI9B,GAAIlC,EAAKmC,SAAWnC,EAAKmC,QAAQxB,OAAQ,CACxCZ,EAAMoC,QAAUnC,EAAKmC,QAGtB,GAAIC,SAASpC,EAAKqC,QAAS,IAAM,EAAG,CACnCtC,EAAMsC,QAAUrC,EAAKqC,QACrBtC,EAAMuC,cAAgBtC,EAAKsC,eAAiB,UAG7C,GAAItC,EAAKuC,UAAW,CACnBxC,EAAMwC,UAAYvC,EAAKuC,UACvBxC,EAAMyC,WAAaxC,EAAKwC,YAAc,QAGvC,GAAIxC,EAAKyC,OAAQ,CAChB1C,EAAM0C,OAASzC,EAAKyC,OACpB1C,EAAM2C,cAAgB1C,EAAK0C,cAG5B,GAAI1C,EAAK2C,OAAQ,CAChB5C,EAAM4C,OAAS3C,EAAK2C,OAGrB,GAAI3C,EAAKiB,WAAY,CACpBlB,EAAMkB,WAAajB,EAAKiB,WAGzBG,EAAEwB,QAAQC,QAAQ,mCACjB9C,MAAOA,EACPC,KAAMA,IAGP,OAAO8C,mBAAmB1B,EAAE2B,MAAMhD,IAGnCF,EAAOmD,qBAAuB,WAC7B,IACC,OAAOC,KAAKC,MAAMtD,EAAQuD,QAAQ,uBAAyB,MAC1D,MAAOtB,GACR,WAIFhC,EAAOuD,iBAAmB,SAAUC,EAAaC,GAChD,IAAKD,IAAgBC,EAAI3C,OAAQ,CAChC,OAED0C,EAAcE,MAAMC,WAAWH,EAAY5C,QAAQ,KAAM,IAAIA,QAAQ,KAAM,IAAIgD,QAC/E,IAAIC,EAAWL,EAAYM,MAAM,KAC/BC,IAAI,SAAUC,GAAQ,OAAON,MAAMO,iBAAiBD,KACpDE,KAAK,KACP,IAAIC,EAAQ,IAAIC,OAAO,IAAMP,EAAW,IAAK,MAE7CJ,EAAIY,KAAK,WACR,IAAI5C,EAASF,EAAE+C,MACf,IAAIC,KAEJ9C,EAAO+C,KAAK,KAAKH,KAAK,WACrB9C,EAAE+C,MAAMG,MAAM,WAAUF,EAAOzD,OAAS,WACxCyD,EAAOG,KAAKnD,EAAE,eAAeoD,OAAOpD,EAAE+C,UAGvC7C,EAAOmD,KAAKnD,EAAOmD,OAAOhE,QAAQuD,EAAO,SAAU5D,EAAOsE,GACzD,MAAO,gCAAkCA,EAAK,eAG/CN,EAAOO,QAAQ,SAAUC,EAAUC,GAClCvD,EAAOmD,KAAKnD,EAAOmD,OAAOhE,QAAQ,WAAUoE,EAAI,UAAQ,WACvD,OAAOD,EAASH,cAKnBrD,EAAE,uBAAuBiD,KAAK,4BAA4BS,SAAS,mBAGpEjF,EAAOe,WAAa,SAAUF,EAAKP,GAClC4E,OAAOC,KAAK,iBACXtE,IAAKA,EACLP,KAAMA,GACJ,SAAU8E,EAAKC,GACjB,GAAID,EAAK,CACR,OAAOnD,IAAIC,WAAWkD,EAAIE,SAG3B,GAAIC,MAAMC,QAAQH,GAAO,CAExBrF,EAAOC,SACNwF,QAASJ,EAAKK,KAAK,SAAUC,EAAGC,GAC/B,OAAOD,EAAIC,IAEZ/E,IAAKA,EACLP,KAAMA,GAGPN,EAAO6F,kBAAkBhF,EAAK,WAC7Bb,EAAO8F,SAASC,OAAO,SAM3B/F,EAAO6F,kBAAoB,SAAUhF,EAAKT,GACzC,GAAImC,SAAS/B,QAAQL,KAAKU,IAAK,MAAQ0B,SAAS1B,EAAK,IAAK,CACzDL,QAAQC,GAAG,SAAWI,EAAKT,OACrB,CACNA,MAIFJ,EAAO8F,UACNE,OAAQ,OAGThG,EAAO8F,SAASG,KAAO,WACtBjG,EAAO8F,SAASC,OAAQ/F,EAAOC,QAAQiG,QAAU,EAAKlG,EAAOC,QAAQwF,QAAQ3E,OAAS,EAAId,EAAOC,QAAQiG,MAAQ,IAGlHlG,EAAO8F,SAASK,KAAO,WACtBnG,EAAO8F,SAASC,OAAQ/F,EAAOC,QAAQiG,QAAUlG,EAAOC,QAAQwF,QAAQ3E,OAAS,EAAK,EAAId,EAAOC,QAAQiG,MAAQ,IAGlHlG,EAAO8F,SAASC,OAAS,SAAUG,GAClC,IAAIE,EAAgB7E,EAAE,iBACtBvB,EAAOC,QAAQiG,MAAQA,EAEvBlG,EAAO8F,SAASO,QAEhB,GAAIrG,EAAOC,QAAQwF,QAAQ3E,OAAS,EAAG,CACtCsF,EAAc5B,KAAK,UAAUI,KAAMsB,EAAQ,EAAK,MAAQlG,EAAOC,QAAQwF,QAAQ3E,QAC/EsF,EAAc5B,KAAK,gBAAgB8B,WAAW,YAC9C,IAAInG,GACHoG,IAAKvG,EAAOC,QAAQwF,QAAQS,GAC5BrF,IAAKb,EAAOC,QAAQY,IACpB2F,cAAetF,OAAOsF,eAEvBtB,OAAOC,KAAK,oBAAqBhF,EAAM,SAAUiF,EAAKqB,GACrD,GAAIrB,EAAK,CACR,OAAOnD,IAAIC,WAAWkD,EAAIE,SAG3BzF,EAAI6G,cAAcD,EAAW,YAExB,CACN3G,EAAW6G,UAAU,wBAAyB,SAAUC,GACvDR,EAAc5B,KAAK,UAAUI,KAAKgC,KAEnCR,EAAcS,YAAY,UAAUrC,KAAK,gBAAgBsC,KAAK,WAAY,cAI5E9G,EAAO8F,SAASO,MAAQ,WACvB9E,EAAE,iBAAiBsF,YAAY,UAC/B,IAAK7G,EAAO8F,SAASE,OAAQ,CAC5BhG,EAAO8F,SAASE,OAAS,KAGzBe,SAAS,aAAc,SAAUC,GAChCA,EAAUC,KAAK,MAAOjH,EAAO8F,SAASoB,SAKzClH,EAAO8F,SAASoB,IAAM,WACrB3F,EAAE,iBAAiB0D,SAAS,UAAUT,KAAK,gBAAgBsC,KAAK,WAAY,YAC5E9G,EAAO8F,SAASE,OAAS,MAGzBe,SAAS,aAAc,SAAUC,GAChCA,EAAUG,OAAO,MAAOnH,EAAO8F,SAASoB,QAI1C,OAAOlH","file":"public/src/modules/search.js","sourcesContent":["'use strict';\n\n\ndefine('search', ['navigator', 'translator', 'storage'], function (nav, translator, storage) {\n\tvar Search = {\n\t\tcurrent: {},\n\t};\n\n\tSearch.query = function (data, callback) {\n\t\t// Detect if a tid was specified\n\t\tvar topicSearch = data.term.match(/^in:topic-([\\d]+) /);\n\t\tcallback = callback || function () {};\n\t\tif (!topicSearch) {\n\t\t\tajaxify.go('search?' + createQueryString(data));\n\t\t\tcallback();\n\t\t} else {\n\t\t\tvar cleanedTerm = data.term.replace(topicSearch[0], '');\n\t\t\tvar tid = topicSearch[1];\n\n\t\t\tif (cleanedTerm.length > 0) {\n\t\t\t\tSearch.queryTopic(tid, cleanedTerm, callback);\n\t\t\t}\n\t\t}\n\t};\n\n\tSearch.api = function (data, callback) {\n\t\tvar apiURL = config.relative_path + '/api/search?' + createQueryString(data);\n\t\tdata.searchOnly = undefined;\n\t\tvar searchURL = config.relative_path + '/search?' + createQueryString(data);\n\t\t$.get(apiURL, function (result) {\n\t\t\tresult.url = searchURL;\n\t\t\tcallback(result);\n\t\t});\n\t};\n\n\tfunction createQueryString(data) {\n\t\tvar searchIn = data.in || 'titles';\n\t\tvar postedBy = data.by || '';\n\t\tvar term = data.term.replace(/^[ ?#]*/, '');\n\t\ttry {\n\t\t\tterm = encodeURIComponent(term);\n\t\t} catch (e) {\n\t\t\treturn app.alertError('[[error:invalid-search-term]]');\n\t\t}\n\n\t\tvar query = {\n\t\t\tterm: term,\n\t\t\tin: searchIn,\n\t\t};\n\n\t\tif (data.matchWords) {\n\t\t\tquery.matchWords = data.matchWords;\n\t\t}\n\n\t\tif (postedBy && postedBy.length && (searchIn === 'posts' || searchIn === 'titles' || searchIn === 'titlesposts')) {\n\t\t\tquery.by = postedBy;\n\t\t}\n\n\t\tif (data.categories && data.categories.length) {\n\t\t\tquery.categories = data.categories;\n\t\t\tif (data.searchChildren) {\n\t\t\t\tquery.searchChildren = data.searchChildren;\n\t\t\t}\n\t\t}\n\n\t\tif (data.hasTags && data.hasTags.length) {\n\t\t\tquery.hasTags = data.hasTags;\n\t\t}\n\n\t\tif (parseInt(data.replies, 10) > 0) {\n\t\t\tquery.replies = data.replies;\n\t\t\tquery.repliesFilter = data.repliesFilter || 'atleast';\n\t\t}\n\n\t\tif (data.timeRange) {\n\t\t\tquery.timeRange = data.timeRange;\n\t\t\tquery.timeFilter = data.timeFilter || 'newer';\n\t\t}\n\n\t\tif (data.sortBy) {\n\t\t\tquery.sortBy = data.sortBy;\n\t\t\tquery.sortDirection = data.sortDirection;\n\t\t}\n\n\t\tif (data.showAs) {\n\t\t\tquery.showAs = data.showAs;\n\t\t}\n\n\t\tif (data.searchOnly) {\n\t\t\tquery.searchOnly = data.searchOnly;\n\t\t}\n\n\t\t$(window).trigger('action:search.createQueryString', {\n\t\t\tquery: query,\n\t\t\tdata: data,\n\t\t});\n\n\t\treturn decodeURIComponent($.param(query));\n\t}\n\n\tSearch.getSearchPreferences = function () {\n\t\ttry {\n\t\t\treturn JSON.parse(storage.getItem('search-preferences') || '{}');\n\t\t} catch (e) {\n\t\t\treturn {};\n\t\t}\n\t};\n\n\tSearch.highlightMatches = function (searchQuery, els) {\n\t\tif (!searchQuery || !els.length) {\n\t\t\treturn;\n\t\t}\n\t\tsearchQuery = utils.escapeHTML(searchQuery.replace(/^\"/, '').replace(/\"$/, '').trim());\n\t\tvar regexStr = searchQuery.split(' ')\n\t\t\t.map(function (word) { return utils.escapeRegexChars(word); })\n\t\t\t.join('|');\n\t\tvar regex = new RegExp('(' + regexStr + ')', 'gi');\n\n\t\tels.each(function () {\n\t\t\tvar result = $(this);\n\t\t\tvar nested = [];\n\n\t\t\tresult.find('*').each(function () {\n\t\t\t\t$(this).after('<!-- ' + nested.length + ' -->');\n\t\t\t\tnested.push($('<div></div>').append($(this)));\n\t\t\t});\n\n\t\t\tresult.html(result.html().replace(regex, function (match, p1) {\n\t\t\t\treturn '<strong class=\"search-match\">' + p1 + '</strong>';\n\t\t\t}));\n\n\t\t\tnested.forEach(function (nestedEl, i) {\n\t\t\t\tresult.html(result.html().replace('<!-- ' + i + ' -->', function () {\n\t\t\t\t\treturn nestedEl.html();\n\t\t\t\t}));\n\t\t\t});\n\t\t});\n\n\t\t$('.search-result-text').find('img:not(.not-responsive)').addClass('img-responsive');\n\t};\n\n\tSearch.queryTopic = function (tid, term) {\n\t\tsocket.emit('topics.search', {\n\t\t\ttid: tid,\n\t\t\tterm: term,\n\t\t}, function (err, pids) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (Array.isArray(pids)) {\n\t\t\t\t// Sort pids numerically & store\n\t\t\t\tSearch.current = {\n\t\t\t\t\tresults: pids.sort(function (a, b) {\n\t\t\t\t\t\treturn a - b;\n\t\t\t\t\t}),\n\t\t\t\t\ttid: tid,\n\t\t\t\t\tterm: term,\n\t\t\t\t};\n\n\t\t\t\tSearch.checkPagePresence(tid, function () {\n\t\t\t\t\tSearch.topicDOM.update(0);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n\n\tSearch.checkPagePresence = function (tid, callback) {\n\t\tif (parseInt(ajaxify.data.tid, 10) !== parseInt(tid, 10)) {\n\t\t\tajaxify.go('topic/' + tid, callback);\n\t\t} else {\n\t\t\tcallback();\n\t\t}\n\t};\n\n\tSearch.topicDOM = {\n\t\tactive: false,\n\t};\n\n\tSearch.topicDOM.prev = function () {\n\t\tSearch.topicDOM.update((Search.current.index === 0) ? Search.current.results.length - 1 : Search.current.index - 1);\n\t};\n\n\tSearch.topicDOM.next = function () {\n\t\tSearch.topicDOM.update((Search.current.index === Search.current.results.length - 1) ? 0 : Search.current.index + 1);\n\t};\n\n\tSearch.topicDOM.update = function (index) {\n\t\tvar topicSearchEl = $('.topic-search');\n\t\tSearch.current.index = index;\n\n\t\tSearch.topicDOM.start();\n\n\t\tif (Search.current.results.length > 0) {\n\t\t\ttopicSearchEl.find('.count').html((index + 1) + ' / ' + Search.current.results.length);\n\t\t\ttopicSearchEl.find('.prev, .next').removeAttr('disabled');\n\t\t\tvar data = {\n\t\t\t\tpid: Search.current.results[index],\n\t\t\t\ttid: Search.current.tid,\n\t\t\t\ttopicPostSort: config.topicPostSort,\n\t\t\t};\n\t\t\tsocket.emit('posts.getPidIndex', data, function (err, postIndex) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tnav.scrollToIndex(postIndex, true);\n\t\t\t});\n\t\t} else {\n\t\t\ttranslator.translate('[[search:no-matches]]', function (text) {\n\t\t\t\ttopicSearchEl.find('.count').html(text);\n\t\t\t});\n\t\t\ttopicSearchEl.removeClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\n\t\t}\n\t};\n\n\tSearch.topicDOM.start = function () {\n\t\t$('.topic-search').removeClass('hidden');\n\t\tif (!Search.topicDOM.active) {\n\t\t\tSearch.topicDOM.active = true;\n\n\t\t\t// Bind to esc\n\t\t\trequire(['mousetrap'], function (mousetrap) {\n\t\t\t\tmousetrap.bind('esc', Search.topicDOM.end);\n\t\t\t});\n\t\t}\n\t};\n\n\tSearch.topicDOM.end = function () {\n\t\t$('.topic-search').addClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\n\t\tSearch.topicDOM.active = false;\n\n\t\t// Unbind esc\n\t\trequire(['mousetrap'], function (mousetrap) {\n\t\t\tmousetrap.unbind('esc', Search.topicDOM.end);\n\t\t});\n\t};\n\n\treturn Search;\n});\n"]}