{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer/tags.js"],"names":["define","tags","minTags","maxTags","init","postContainer","postData","tagEl","find","length","ajaxify","data","hasOwnProperty","config","minimumTagsPerTopic","maximumTagsPerTopic","tagsinput","confirmKeys","trimValue","input","toggleTagInput","app","loadJQueryUI","autocomplete","delay","position","my","at","collision","appendTo","open","$","this","css","source","request","response","socket","emit","query","term","cid","err","alertError","message","attr","select","triggerEnter","addTags","on","event","reachedMaxTags","getTags","cleanTag","utils","cleanUpTag","item","maximumTagLength","different","cancel","minimumTagLength","skipAddCheck","skipRemoveCheck","tag","allowed","window","trigger","isEnoughTags","post_uuid","minTagCount","onChangeCategory","categoryData","tagDropdown","toggleClass","tagWhitelist","parseAndTranslate","html","slice","forEach","indexOf","removeAttr","privileges","tagsInput","e","jQuery","Event","which","keyCode","setTimeout","i"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer/tags.js","sourcesContent":["\n'use strict';\n\n/* globals jQuery, ajaxify, define, config, socket, app, utils, $, window */\n\ndefine('composer/tags', function () {\n\tvar tags = {};\n\n\tvar minTags;\n\tvar maxTags;\n\n\ttags.init = function (postContainer, postData) {\n\t\tvar tagEl = postContainer.find('.tags');\n\t\tif (!tagEl.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tminTags = ajaxify.data.hasOwnProperty('minTags') ? ajaxify.data.minTags : config.minimumTagsPerTopic;\n\t\tmaxTags = ajaxify.data.hasOwnProperty('maxTags') ? ajaxify.data.maxTags : config.maximumTagsPerTopic;\n\n\t\ttagEl.tagsinput({\n\t\t\tconfirmKeys: [13, 44],\n\t\t\ttrimValue: true,\n\t\t});\n\t\tvar input = postContainer.find('.bootstrap-tagsinput input');\n\n\t\ttoggleTagInput(postContainer, postData, ajaxify.data);\n\n\t\tapp.loadJQueryUI(function () {\n\t\t\tinput.autocomplete({\n\t\t\t\tdelay: 100,\n\t\t\t\tposition: { my: 'left bottom', at: 'left top', collision: 'flip' },\n\t\t\t\tappendTo: postContainer.find('.bootstrap-tagsinput'),\n\t\t\t\topen: function () {\n\t\t\t\t\t$(this).autocomplete('widget').css('z-index', 20000);\n\t\t\t\t},\n\t\t\t\tsource: function (request, response) {\n\t\t\t\t\tsocket.emit('topics.autocompleteTags', {\n\t\t\t\t\t\tquery: request.term,\n\t\t\t\t\t\tcid: postData.cid,\n\t\t\t\t\t}, function (err, tags) {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (tags) {\n\t\t\t\t\t\t\tresponse(tags);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$('.ui-autocomplete a').attr('data-ajaxify', 'false');\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tselect: function (/* event, ui */) {\n\t\t\t\t\t// when autocomplete is selected from the dropdown simulate a enter key down to turn it into a tag\n\t\t\t\t\ttriggerEnter(input);\n\t\t\t\t},\n\t\t\t});\n\n\t\t\taddTags(postData.tags, tagEl);\n\n\t\t\ttagEl.on('beforeItemAdd', function (event) {\n\t\t\t\tvar reachedMaxTags = maxTags && maxTags <= tags.getTags(postContainer.attr('data-uuid')).length;\n\t\t\t\tvar cleanTag = utils.cleanUpTag(event.item, config.maximumTagLength);\n\t\t\t\tvar different = cleanTag !== event.item;\n\t\t\t\tevent.cancel = different ||\n\t\t\t\t\tevent.item.length < config.minimumTagLength ||\n\t\t\t\t\tevent.item.length > config.maximumTagLength ||\n\t\t\t\t\treachedMaxTags;\n\n\t\t\t\tif (event.item.length < config.minimumTagLength) {\n\t\t\t\t\treturn app.alertError('[[error:tag-too-short, ' + config.minimumTagLength + ']]');\n\t\t\t\t} else if (event.item.length > config.maximumTagLength) {\n\t\t\t\t\treturn app.alertError('[[error:tag-too-long, ' + config.maximumTagLength + ']]');\n\t\t\t\t} else if (reachedMaxTags) {\n\t\t\t\t\treturn app.alertError('[[error:too-many-tags, ' + maxTags + ']]');\n\t\t\t\t}\n\t\t\t\tif (different) {\n\t\t\t\t\ttagEl.tagsinput('add', cleanTag);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvar skipAddCheck = false;\n\t\t\tvar skipRemoveCheck = false;\n\t\t\ttagEl.on('itemRemoved', function (event) {\n\t\t\t\tif (skipRemoveCheck) {\n\t\t\t\t\tskipRemoveCheck = false;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tsocket.emit('topics.canRemoveTag', { tag: event.item }, function (err, allowed) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tif (!allowed) {\n\t\t\t\t\t\tapp.alertError('[[error:cant-remove-system-tag]]');\n\t\t\t\t\t\tskipAddCheck = true;\n\t\t\t\t\t\ttagEl.tagsinput('add', event.item);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\ttagEl.on('itemAdded', function (event) {\n\t\t\t\tif (skipAddCheck) {\n\t\t\t\t\tskipAddCheck = false;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvar cid = postData.hasOwnProperty('cid') ? postData.cid : ajaxify.data.cid;\n\t\t\t\tsocket.emit('topics.isTagAllowed', { tag: event.item, cid: cid || 0 }, function (err, allowed) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tif (!allowed) {\n\t\t\t\t\t\tskipRemoveCheck = true;\n\t\t\t\t\t\treturn tagEl.tagsinput('remove', event.item);\n\t\t\t\t\t}\n\t\t\t\t\t$(window).trigger('action:tag.added', { cid: cid, tagEl: tagEl, tag: event.item });\n\t\t\t\t\tif (input.length) {\n\t\t\t\t\t\tinput.autocomplete('close');\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tinput.attr('tabIndex', tagEl.attr('tabIndex'));\n\t\tinput.on('blur', function () {\n\t\t\ttriggerEnter(input);\n\t\t});\n\n\t\t$('[component=\"composer/tag/dropdown\"]').on('click', 'li', function () {\n\t\t\tvar tag = $(this).attr('data-tag');\n\t\t\tif (tag) {\n\t\t\t\taddTags([tag], tagEl);\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t};\n\n\ttags.isEnoughTags = function (post_uuid) {\n\t\treturn tags.getTags(post_uuid).length >= minTags;\n\t};\n\n\ttags.minTagCount = function () {\n\t\treturn minTags;\n\t};\n\n\ttags.onChangeCategory = function (postContainer, postData, cid, categoryData) {\n\t\tvar tagDropdown = postContainer.find('[component=\"composer/tag/dropdown\"]');\n\t\tif (!tagDropdown.length) {\n\t\t\treturn;\n\t\t}\n\n\t\ttoggleTagInput(postContainer, postData, categoryData);\n\t\ttagDropdown.toggleClass('hidden', !categoryData.tagWhitelist || !categoryData.tagWhitelist.length);\n\t\tif (categoryData.tagWhitelist) {\n\t\t\tapp.parseAndTranslate('composer', 'tagWhitelist', { tagWhitelist: categoryData.tagWhitelist }, function (html) {\n\t\t\t\ttagDropdown.find('.dropdown-menu').html(html);\n\t\t\t});\n\t\t}\n\t};\n\n\tfunction toggleTagInput(postContainer, postData, data) {\n\t\tvar tagEl = postContainer.find('.tags');\n\t\tvar input = postContainer.find('.bootstrap-tagsinput input');\n\t\tif (!input.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (data.hasOwnProperty('minTags')) {\n\t\t\tminTags = data.minTags;\n\t\t}\n\t\tif (data.hasOwnProperty('maxTags')) {\n\t\t\tmaxTags = data.maxTags;\n\t\t}\n\n\t\tif (data.tagWhitelist && data.tagWhitelist.length) {\n\t\t\tinput.attr('readonly', '');\n\t\t\tinput.attr('placeholder', '');\n\n\t\t\ttagEl.tagsinput('items').slice().forEach(function (tag) {\n\t\t\t\tif (data.tagWhitelist.indexOf(tag) === -1) {\n\t\t\t\t\ttagEl.tagsinput('remove', tag);\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tinput.removeAttr('readonly');\n\t\t\tinput.attr('placeholder', postContainer.find('input.tags').attr('placeholder'));\n\t\t}\n\n\t\tpostContainer.find('.tags-container').toggleClass('hidden', (\n\t\t\tdata.privileges && data.privileges.hasOwnProperty('topics:tag') && !data.privileges['topics:tag']) ||\n\t\t\t(maxTags === 0 && !postData.tags.length)\n\t\t);\n\n\t\tif (data.privileges && data.privileges.hasOwnProperty('topics:tag') && !data.privileges['topics:tag']) {\n\t\t\ttagEl.tagsinput('removeAll');\n\t\t}\n\n\t\t$(window).trigger('action:tag.toggleInput', {\n\t\t\tpostContainer: postContainer,\n\t\t\ttagWhitelist: data.tagWhitelist,\n\t\t\ttagsInput: input,\n\t\t});\n\t}\n\n\tfunction triggerEnter(input) {\n\t\t// http://stackoverflow.com/a/3276819/583363\n\t\tvar e = jQuery.Event('keypress');\n\t\te.which = 13;\n\t\te.keyCode = 13;\n\t\tsetTimeout(function () {\n\t\t\tinput.trigger(e);\n\t\t}, 100);\n\t}\n\n\tfunction addTags(tags, tagEl) {\n\t\tif (tags && tags.length) {\n\t\t\tfor (var i = 0; i < tags.length; ++i) {\n\t\t\t\ttagEl.tagsinput('add', tags[i]);\n\t\t\t}\n\t\t}\n\t}\n\n\ttags.getTags = function (post_uuid) {\n\t\treturn $('.composer[data-uuid=\"' + post_uuid + '\"] .tags').tagsinput('items');\n\t};\n\n\treturn tags;\n});\n"]}