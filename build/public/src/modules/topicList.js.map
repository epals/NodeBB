{"version":3,"sources":["public/src/modules/topicList.js"],"names":["define","infinitescroll","handleBack","topicSelect","categoryFilter","categoryTools","TopicList","templateName","tplToSort","recent","unread","popular","top","newTopicCount","newPostCount","loadTopicsCallback","topicListEl","scheduledTopics","$","window","on","removeListeners","init","template","cb","findTopicListElement","loadTopicsAfter","watchForNewPosts","states","ajaxify","data","selectedFilter","filter","push","config","usePagination","loadMoreTopics","after","handleBackCallback","loadCallback","onTopicsLoaded","topics","showSelect","height","children","length","show","trigger","i","e","parents","this","addClass","socket","onNewTopic","onNewPost","removeListener","d","categories","selectedCids","indexOf","parseInt","cid","filterWatched","category","includes","tid","scheduled","updateAlertText","post","posts","topic","isFollowing","isMain","mainPid","pid","filterNew","text","translateText","removeClass","fadeIn","direction","find","afterEl","last","first","attr","utils","isNumber","done","callback","query","params","loadMore","sort","count","topicsPerPage","tags","term","selectedTerm","set","filterTopicsOnDom","hide","before","topicEls","tplData","name","app","parseAndTranslate","html","remove","insertAfter","document","scrollTop","insertBefore","append","getSelectedTids","removeExtra","Math","max","timeago","createUserTooltips","makeNumbersHumanReadable"],"mappings":"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","file":"public/src/modules/topicList.js","sourcesContent":["'use strict';\n\ndefine('topicList', [\n\t'forum/infinitescroll',\n\t'handleBack',\n\t'topicSelect',\n\t'categoryFilter',\n\t'forum/category/tools',\n], function (infinitescroll, handleBack, topicSelect, categoryFilter, categoryTools) {\n\tvar TopicList = {};\n\tvar templateName = '';\n\n\tvar tplToSort = {\n\t\trecent: 'recent',\n\t\tunread: 'unread',\n\t\tpopular: 'posts',\n\t\ttop: 'votes',\n\t};\n\n\tvar newTopicCount = 0;\n\tvar newPostCount = 0;\n\n\tvar loadTopicsCallback;\n\tvar topicListEl;\n\n\tconst scheduledTopics = [];\n\n\t$(window).on('action:ajaxify.start', function () {\n\t\tTopicList.removeListeners();\n\t\tcategoryTools.removeListeners();\n\t});\n\n\tTopicList.init = function (template, cb) {\n\t\ttopicListEl = findTopicListElement();\n\n\t\ttemplateName = template;\n\t\tloadTopicsCallback = cb || loadTopicsAfter;\n\n\t\tcategoryTools.init();\n\n\t\tTopicList.watchForNewPosts();\n\t\tvar states = ['watching'];\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'watched') {\n\t\t\tstates.push('notwatching', 'ignoring');\n\t\t} else if (template !== 'unread') {\n\t\t\tstates.push('notwatching');\n\t\t}\n\n\t\tcategoryFilter.init($('[component=\"category/dropdown\"]'), {\n\t\t\tstates: states,\n\t\t});\n\n\t\tif (!config.usePagination) {\n\t\t\tinfinitescroll.init(TopicList.loadMoreTopics);\n\t\t}\n\n\t\thandleBack.init(function (after, handleBackCallback) {\n\t\t\tloadTopicsCallback(after, 1, function (data, loadCallback) {\n\t\t\t\tTopicList.onTopicsLoaded(templateName, data.topics, ajaxify.data.showSelect, 1, function () {\n\t\t\t\t\thandleBackCallback();\n\t\t\t\t\tloadCallback();\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tif ($('body').height() <= $(window).height() && topicListEl.children().length >= 20) {\n\t\t\t$('#load-more-btn').show();\n\t\t}\n\n\t\t$('#load-more-btn').on('click', function () {\n\t\t\tTopicList.loadMoreTopics(1);\n\t\t});\n\n\t\t$(window).trigger('action:topics.loaded', { topics: ajaxify.data.topics });\n\t};\n\n\tfunction findTopicListElement() {\n\t\treturn $('[component=\"category\"]').filter(function (i, e) {\n\t\t\treturn !$(e).parents('[widget-area],[data-widget-area]').length;\n\t\t});\n\t}\n\n\tTopicList.watchForNewPosts = function () {\n\t\t$('#new-topics-alert').on('click', function () {\n\t\t\t$(this).addClass('hide');\n\t\t});\n\t\tnewPostCount = 0;\n\t\tnewTopicCount = 0;\n\t\tTopicList.removeListeners();\n\t\tsocket.on('event:new_topic', onNewTopic);\n\t\tsocket.on('event:new_post', onNewPost);\n\t};\n\n\tTopicList.removeListeners = function () {\n\t\tsocket.removeListener('event:new_topic', onNewTopic);\n\t\tsocket.removeListener('event:new_post', onNewPost);\n\t};\n\n\tfunction onNewTopic(data) {\n\t\tconst d = ajaxify.data;\n\n\t\tconst categories = d.selectedCids &&\n\t\t\td.selectedCids.length &&\n\t\t\td.selectedCids.indexOf(parseInt(data.cid, 10)) === -1;\n\t\tconst filterWatched = d.selectedFilter &&\n\t\t\td.selectedFilter.filter === 'watched';\n\t\tconst category = d.template.category &&\n\t\t\tparseInt(d.cid, 10) !== parseInt(data.cid, 10);\n\n\t\tif (categories || filterWatched || category || scheduledTopics.includes(data.tid)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (data.scheduled && data.tid) {\n\t\t\tscheduledTopics.push(data.tid);\n\t\t}\n\t\tnewTopicCount += 1;\n\t\tupdateAlertText();\n\t}\n\n\tfunction onNewPost(data) {\n\t\tvar post = data.posts[0];\n\t\tif (!post || !post.topic || post.topic.isFollowing) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst d = ajaxify.data;\n\n\t\tconst isMain = parseInt(post.topic.mainPid, 10) === parseInt(post.pid, 10);\n\t\tconst categories = d.selectedCids &&\n\t\t\td.selectedCids.length &&\n\t\t\td.selectedCids.indexOf(parseInt(post.topic.cid, 10)) === -1;\n\t\tconst filterNew = d.selectedFilter &&\n\t\t\td.selectedFilter.filter === 'new';\n\t\tconst filterWatched = d.selectedFilter &&\n\t\t\td.selectedFilter.filter === 'watched' &&\n\t\t\t!post.topic.isFollowing;\n\t\tconst category = d.template.category &&\n\t\t\tparseInt(d.cid, 10) !== parseInt(post.topic.cid, 10);\n\n\t\tif (isMain || categories || filterNew || filterWatched || category) {\n\t\t\treturn;\n\t\t}\n\n\t\tnewPostCount += 1;\n\t\tupdateAlertText();\n\t}\n\n\tfunction updateAlertText() {\n\t\tvar text = '';\n\n\t\tif (newTopicCount === 0) {\n\t\t\tif (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount === 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic]]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount > 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-are-new-topics, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-a-new-post, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-new-posts, ' + newTopicCount + ', ' + newPostCount + ']]';\n\t\t\t}\n\t\t}\n\n\t\ttext += ' [[recent:click-here-to-reload]]';\n\n\t\t$('#new-topics-alert').translateText(text).removeClass('hide').fadeIn('slow');\n\t\t$('#category-no-topics').addClass('hide');\n\t}\n\n\tTopicList.loadMoreTopics = function (direction) {\n\t\tif (!topicListEl.length || !topicListEl.children().length) {\n\t\t\treturn;\n\t\t}\n\t\tvar topics = topicListEl.find('[component=\"category/topic\"]');\n\t\tvar afterEl = direction > 0 ? topics.last() : topics.first();\n\t\tvar after = (parseInt(afterEl.attr('data-index'), 10) || 0) + (direction > 0 ? 1 : 0);\n\n\t\tif (!utils.isNumber(after) || (after === 0 && topicListEl.find('[component=\"category/topic\"][data-index=\"0\"]').length)) {\n\t\t\treturn;\n\t\t}\n\n\t\tloadTopicsCallback(after, direction, function (data, done) {\n\t\t\tTopicList.onTopicsLoaded(templateName, data.topics, ajaxify.data.showSelect, direction, done);\n\t\t});\n\t};\n\n\tfunction loadTopicsAfter(after, direction, callback) {\n\t\tcallback = callback || function () {};\n\t\tvar query = utils.params();\n\t\tinfinitescroll.loadMore('topics.loadMoreSortedTopics', {\n\t\t\tafter: after,\n\t\t\tdirection: direction,\n\t\t\tsort: tplToSort[templateName],\n\t\t\tcount: config.topicsPerPage,\n\t\t\tcid: query.cid,\n\t\t\ttags: query.tags,\n\t\t\tquery: query,\n\t\t\tterm: ajaxify.data.selectedTerm && ajaxify.data.selectedTerm.term,\n\t\t\tfilter: ajaxify.data.selectedFilter.filter,\n\t\t\tset: topicListEl.attr('data-set') ? topicListEl.attr('data-set') : 'topics:recent',\n\t\t}, callback);\n\t}\n\n\tfunction filterTopicsOnDom(topics) {\n\t\treturn topics.filter(function (topic) {\n\t\t\treturn !topicListEl.find('[component=\"category/topic\"][data-tid=\"' + topic.tid + '\"]').length;\n\t\t});\n\t}\n\n\tTopicList.onTopicsLoaded = function (templateName, topics, showSelect, direction, callback) {\n\t\tif (!topics || !topics.length) {\n\t\t\t$('#load-more-btn').hide();\n\t\t\treturn callback();\n\t\t}\n\t\ttopics = filterTopicsOnDom(topics);\n\n\t\tif (!topics.length) {\n\t\t\t$('#load-more-btn').hide();\n\t\t\treturn callback();\n\t\t}\n\n\t\tvar after;\n\t\tvar before;\n\t\tvar topicEls = topicListEl.find('[component=\"category/topic\"]');\n\n\t\tif (direction > 0 && topics.length) {\n\t\t\tafter = topicEls.last();\n\t\t} else if (direction < 0 && topics.length) {\n\t\t\tbefore = topicEls.first();\n\t\t}\n\n\t\tvar tplData = {\n\t\t\ttopics: topics,\n\t\t\tshowSelect: showSelect,\n\t\t\ttemplate: {\n\t\t\t\tname: templateName,\n\t\t\t},\n\t\t};\n\t\ttplData.template[templateName] = true;\n\n\t\tapp.parseAndTranslate(templateName, 'topics', tplData, function (html) {\n\t\t\ttopicListEl.removeClass('hidden');\n\t\t\t$('#category-no-topics').remove();\n\n\t\t\tif (after && after.length) {\n\t\t\t\thtml.insertAfter(after);\n\t\t\t} else if (before && before.length) {\n\t\t\t\tvar height = $(document).height();\n\t\t\t\tvar scrollTop = $(window).scrollTop();\n\n\t\t\t\thtml.insertBefore(before);\n\n\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\n\t\t\t} else {\n\t\t\t\ttopicListEl.append(html);\n\t\t\t}\n\n\t\t\tif (!topicSelect.getSelectedTids().length) {\n\t\t\t\tinfinitescroll.removeExtra(topicListEl.find('[component=\"category/topic\"]'), direction, Math.max(60, config.topicsPerPage * 3));\n\t\t\t}\n\n\t\t\thtml.find('.timeago').timeago();\n\t\t\tapp.createUserTooltips(html);\n\t\t\tutils.makeNumbersHumanReadable(html.find('.human-readable-number'));\n\t\t\t$(window).trigger('action:topics.loaded', { topics: topics, template: templateName });\n\t\t\tcallback();\n\t\t});\n\t};\n\n\treturn TopicList;\n});\n"]}