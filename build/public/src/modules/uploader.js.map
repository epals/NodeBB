{"version":3,"sources":["public/src/modules/uploader.js"],"names":["define","module","show","data","callback","fileSize","hasOwnProperty","undefined","parseInt","app","parseAndTranslate","showHelp","title","description","button","accept","replace","uploadModal","modal","on","remove","uploadForm","find","attr","route","val","JSON","stringify","params","$","this","addClass","submit","onSubmit","hideAlerts","showAlert","css","removeClass","fileInput","hasValidFileSize","ajaxSubmit","type","message","translateText","v3","startsWith","config","relative_path","headers","x-csrf-token","csrf_token","error","xhr","maybeParse","responseJSON","statusText","status","uploadProgress","event","position","total","percent","success","response","code","images","url","setTimeout","parseJSON","e","fileElement","maxSize","window","FileReader","files","size"],"mappings":"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","file":"public/src/modules/uploader.js","sourcesContent":["'use strict';\n\n\ndefine('uploader', ['jquery-form'], function () {\n\tvar module = {};\n\n\tmodule.show = function (data, callback) {\n\t\tvar fileSize = data.hasOwnProperty('fileSize') && data.fileSize !== undefined ? parseInt(data.fileSize, 10) : false;\n\t\tapp.parseAndTranslate('partials/modals/upload_file_modal', {\n\t\t\tshowHelp: data.hasOwnProperty('showHelp') && data.showHelp !== undefined ? data.showHelp : true,\n\t\t\tfileSize: fileSize,\n\t\t\ttitle: data.title || '[[global:upload_file]]',\n\t\t\tdescription: data.description || '',\n\t\t\tbutton: data.button || '[[global:upload]]',\n\t\t\taccept: data.accept ? data.accept.replace(/,/g, '&#44; ') : '',\n\t\t}, function (uploadModal) {\n\t\t\tuploadModal.modal('show');\n\t\t\tuploadModal.on('hidden.bs.modal', function () {\n\t\t\t\tuploadModal.remove();\n\t\t\t});\n\n\t\t\tvar uploadForm = uploadModal.find('#uploadForm');\n\t\t\tuploadForm.attr('action', data.route);\n\t\t\tuploadForm.find('#params').val(JSON.stringify(data.params));\n\n\t\t\tuploadModal.find('#fileUploadSubmitBtn').on('click', function () {\n\t\t\t\t$(this).addClass('disabled');\n\t\t\t\tuploadForm.submit();\n\t\t\t});\n\n\t\t\tuploadForm.submit(function () {\n\t\t\t\tonSubmit(uploadModal, fileSize, callback);\n\t\t\t\treturn false;\n\t\t\t});\n\t\t});\n\t};\n\n\tmodule.hideAlerts = function (modal) {\n\t\t$(modal).find('#alert-status, #alert-success, #alert-error, #upload-progress-box').addClass('hide');\n\t};\n\n\tfunction onSubmit(uploadModal, fileSize, callback) {\n\t\tshowAlert(uploadModal, 'status', '[[uploads:uploading-file]]');\n\n\t\tuploadModal.find('#upload-progress-bar').css('width', '0%');\n\t\tuploadModal.find('#upload-progress-box').show().removeClass('hide');\n\n\t\tvar fileInput = uploadModal.find('#fileInput');\n\t\tif (!fileInput.val()) {\n\t\t\treturn showAlert(uploadModal, 'error', '[[uploads:select-file-to-upload]]');\n\t\t}\n\t\tif (!hasValidFileSize(fileInput[0], fileSize)) {\n\t\t\treturn showAlert(uploadModal, 'error', '[[error:file-too-big, ' + fileSize + ']]');\n\t\t}\n\n\t\tmodule.ajaxSubmit(uploadModal, callback);\n\t}\n\n\tfunction showAlert(uploadModal, type, message) {\n\t\tmodule.hideAlerts(uploadModal);\n\t\tif (type === 'error') {\n\t\t\tuploadModal.find('#fileUploadSubmitBtn').removeClass('disabled');\n\t\t}\n\t\tuploadModal.find('#alert-' + type).translateText(message).removeClass('hide');\n\t}\n\n\tmodule.ajaxSubmit = function (uploadModal, callback) {\n\t\tconst uploadForm = uploadModal.find('#uploadForm');\n\t\tconst v3 = uploadForm.attr('action').startsWith(config.relative_path + '/api/v3/');\n\t\tuploadForm.ajaxSubmit({\n\t\t\theaders: {\n\t\t\t\t'x-csrf-token': config.csrf_token,\n\t\t\t},\n\t\t\terror: function (xhr) {\n\t\t\t\txhr = maybeParse(xhr);\n\t\t\t\tshowAlert(uploadModal, 'error', xhr.responseJSON ? (xhr.responseJSON.error || xhr.statusText) : 'error uploading, code : ' + xhr.status);\n\t\t\t},\n\t\t\tuploadProgress: function (event, position, total, percent) {\n\t\t\t\tuploadModal.find('#upload-progress-bar').css('width', percent + '%');\n\t\t\t},\n\t\t\tsuccess: function (response) {\n\t\t\t\tresponse = maybeParse(response);\n\n\t\t\t\t// Appropriately handle v3 API responses\n\t\t\t\tif (v3) {\n\t\t\t\t\tif (response.status.code === 'ok') {\n\t\t\t\t\t\tresponse = response.response.images;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresponse = {\n\t\t\t\t\t\t\terror: response.status.code,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (response.error) {\n\t\t\t\t\treturn showAlert(uploadModal, 'error', response.error);\n\t\t\t\t}\n\n\t\t\t\tcallback(response[0].url);\n\n\t\t\t\tshowAlert(uploadModal, 'success', '[[uploads:upload-success]]');\n\t\t\t\tsetTimeout(function () {\n\t\t\t\t\tmodule.hideAlerts(uploadModal);\n\t\t\t\t\tuploadModal.modal('hide');\n\t\t\t\t}, 750);\n\t\t\t},\n\t\t});\n\t};\n\n\tfunction maybeParse(response) {\n\t\tif (typeof response === 'string') {\n\t\t\ttry {\n\t\t\t\treturn $.parseJSON(response);\n\t\t\t} catch (e) {\n\t\t\t\treturn { error: '[[error:parse-error]]' };\n\t\t\t}\n\t\t}\n\t\treturn response;\n\t}\n\n\tfunction hasValidFileSize(fileElement, maxSize) {\n\t\tif (window.FileReader && maxSize) {\n\t\t\treturn fileElement.files[0].size <= maxSize * 1000;\n\t\t}\n\t\treturn true;\n\t}\n\n\treturn module;\n});\n"]}