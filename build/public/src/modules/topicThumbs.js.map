{"version":3,"sources":["public/src/modules/topicThumbs.js"],"names":["define","api","bootbox","uploader","Benchpress","translator","Thumbs","get","id","getByPid","pid","then","post","tid","delete","path","del","deleteAll","thumbs","Promise","all","map","thumb","url","upload","resolve","show","title","method","route","config","relative_path","modal","open","payload","numThumbs","results","reduce","memo","cur","concat","length","render","html","translate","translated","find","handleSort","dialog","message","buttons","add","label","className","callback","require","composer","updateThumbCount","$","close","handleDelete","modalEl","addEventListener","ev","target","closest","confirm","ok","getAttribute","catch","app","alertError","selectorEl","sortable","items","on","handleSortChange","ui","item","parentNode","querySelectorAll","Array","from","forEach","el","order","replace","RegExp","upload_url","put"],"mappings":"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","file":"public/src/modules/topicThumbs.js","sourcesContent":["'use strict';\n\ndefine('topicThumbs', ['api', 'bootbox', 'uploader', 'benchpress', 'translator', 'jquery-ui/widgets/sortable'], function (api, bootbox, uploader, Benchpress, translator) {\n\tconst Thumbs = {};\n\n\tThumbs.get = id => api.get(`/topics/${id}/thumbs`, {});\n\n\tThumbs.getByPid = pid => api.get(`/posts/${pid}`, {}).then(post => Thumbs.get(post.tid));\n\n\tThumbs.delete = (id, path) => api.del(`/topics/${id}/thumbs`, {\n\t\tpath: path,\n\t});\n\n\tThumbs.deleteAll = (id) => {\n\t\tThumbs.get(id).then((thumbs) => {\n\t\t\tPromise.all(thumbs.map(thumb => Thumbs.delete(id, thumb.url)));\n\t\t});\n\t};\n\n\tThumbs.upload = id => new Promise((resolve) => {\n\t\tuploader.show({\n\t\t\ttitle: '[[topic:composer.thumb_title]]',\n\t\t\tmethod: 'put',\n\t\t\troute: config.relative_path + `/api/v3/topics/${id}/thumbs`,\n\t\t}, function (url) {\n\t\t\tresolve(url);\n\t\t});\n\t});\n\n\tThumbs.modal = {};\n\n\tThumbs.modal.open = function (payload) {\n\t\tconst { id, pid } = payload;\n\t\tlet { modal } = payload;\n\t\tlet numThumbs;\n\n\t\treturn new Promise((resolve) => {\n\t\t\tPromise.all([\n\t\t\t\tThumbs.get(id),\n\t\t\t\tpid ? Thumbs.getByPid(pid) : [],\n\t\t\t]).then(results => new Promise((resolve) => {\n\t\t\t\tconst thumbs = results.reduce((memo, cur) => memo.concat(cur));\n\t\t\t\tnumThumbs = thumbs.length;\n\n\t\t\t\tresolve(thumbs);\n\t\t\t})).then(thumbs => Benchpress.render('modals/topic-thumbs', { thumbs })).then((html) => {\n\t\t\t\tif (modal) {\n\t\t\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\t\t\tmodal.find('.bootbox-body').html(translated);\n\t\t\t\t\t\tThumbs.modal.handleSort({ modal, numThumbs });\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[modules:thumbs.modal.title]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\tadd: {\n\t\t\t\t\t\t\t\tlabel: '<i class=\"fa fa-plus\"></i> [[modules:thumbs.modal.add]]',\n\t\t\t\t\t\t\t\tclassName: 'btn-success',\n\t\t\t\t\t\t\t\tcallback: () => {\n\t\t\t\t\t\t\t\t\tThumbs.upload(id).then(() => {\n\t\t\t\t\t\t\t\t\t\tThumbs.modal.open({ ...payload, modal });\n\t\t\t\t\t\t\t\t\t\trequire(['composer'], (composer) => {\n\t\t\t\t\t\t\t\t\t\t\tcomposer.updateThumbCount(id, $(`[component=\"composer\"][data-uuid=\"${id}\"]`));\n\t\t\t\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tclose: {\n\t\t\t\t\t\t\t\tlabel: '[[global:close]]',\n\t\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tThumbs.modal.handleDelete({ ...payload, modal });\n\t\t\t\t\tThumbs.modal.handleSort({ modal, numThumbs });\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tThumbs.modal.handleDelete = (payload) => {\n\t\tconst modalEl = payload.modal.get(0);\n\n\t\tmodalEl.addEventListener('click', (ev) => {\n\t\t\tif (ev.target.closest('button[data-action=\"remove\"]')) {\n\t\t\t\tbootbox.confirm('[[modules:thumbs.modal.confirm-remove]]', (ok) => {\n\t\t\t\t\tif (!ok) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst id = ev.target.closest('.media[data-id]').getAttribute('data-id');\n\t\t\t\t\tconst path = ev.target.closest('.media[data-path]').getAttribute('data-path');\n\t\t\t\t\tapi.del(`/topics/${id}/thumbs`, {\n\t\t\t\t\t\tpath: path,\n\t\t\t\t\t}).then(() => {\n\t\t\t\t\t\tThumbs.modal.open(payload);\n\t\t\t\t\t}).catch(app.alertError);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n\n\tThumbs.modal.handleSort = ({ modal, numThumbs }) => {\n\t\tif (numThumbs > 1) {\n\t\t\tconst selectorEl = modal.find('.topic-thumbs-modal');\n\t\t\tselectorEl.sortable({\n\t\t\t\titems: '[data-id]',\n\t\t\t});\n\t\t\tselectorEl.on('sortupdate', Thumbs.modal.handleSortChange);\n\t\t}\n\t};\n\n\tThumbs.modal.handleSortChange = (ev, ui) => {\n\t\tconst items = ui.item.get(0).parentNode.querySelectorAll('[data-id]');\n\t\tArray.from(items).forEach((el, order) => {\n\t\t\tconst id = el.getAttribute('data-id');\n\t\t\tlet path = el.getAttribute('data-path');\n\t\t\tpath = path.replace(new RegExp(`^${config.upload_url}`), '');\n\n\t\t\tapi.put(`/topics/${id}/thumbs/order`, { path, order }).catch(app.alertError);\n\t\t});\n\t};\n\n\treturn Thumbs;\n});\n"]}