{"version":3,"sources":["public/src/client/topic/posts.js"],"names":["define","pagination","infinitescroll","postTools","images","navigator","components","translator","hooks","Posts","onNewPost","data","posts","length","parseInt","tid","ajaxify","loggedIn","app","user","uid","privileges","timestamp","topic","scheduled","Date","now","timestampISO","utils","toISOString","modifyPostsByPrivileges","updatePostCounts","updatePostIndices","postcount","updatePostCount","config","usePagination","onNewPostPagination","onNewPostInfiniteScroll","require","replies","forEach","post","selfPost","topicOwnerPost","display_edit_tools","isAdminOrMod","display_delete_tools","display_moderator_tools","display_move_tools","display_post_menu","locked","deleted","deleterUid","postSharing","i","cmp","get","html","attr","addCommasToNumbers","topicPostSort","index","not","each","newIndex","$","this","scrollToPost","scrollToPostIfSelf","pageCount","Math","max","ceil","postsPerPage","direction","isPostVisible","currentPage","createNewPosts","scrollToMyPost","setTimeout","loadPage","updatePagination","relative_path","page","paginationData","parseAndTranslate","after","remove","isPreviousPostAdded","go","pid","addClass","scrollBottom","repliesSelector","userScrolled","callback","removeAlreadyAddedPosts","newPosts","allSamePids","el","removeClass","p","hasClass","filter","before","last","first","window","trigger","Object","assign","insertAfter","height","document","scrollTop","insertBefore","append","removeExtra","fire","onNewPostsAddedToDom","loadMorePosts","scrollActive","find","afterEl","isNumber","indicatorEl","is","fadeIn","loadMore","count","done","fadeOut","update","onTopicPageLoad","handlePrivateUploads","wrapImagesInLinks","showBottomPostBar","addBlockquoteEllipses","hidePostToolsForDeletedPosts","addTopicEvents","addNecroPostMessage","events","Array","isArray","eventIdsInDOM","from","querySelectorAll","map","getAttribute","event","includes","id","postTimestamps","reverse","slice","Promise","all","beforeIdx","findIndex","postEl","querySelector","resolve","then","timeago","necroThreshold","prev","diff","abs","suffixAgo","settings","strings","prefixAgo","suffixFromNow","prefixFromNow","translationText","inWords","text","privateUploads","loginEl","createElement","className","href","translate","translated","appendChild","createTextNode","idx","imgEl","startsWith","upload_url","replaceWith","cloneNode","createUserTooltips","makeNumbersHumanReadable","mainPost","placeHolder","clone","toggle","blockquotes","$this"],"mappings":"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","file":"public/src/client/topic/posts.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/posts', [\n\t'forum/pagination',\n\t'forum/infinitescroll',\n\t'forum/topic/postTools',\n\t'forum/topic/images',\n\t'navigator',\n\t'components',\n\t'translator',\n\t'hooks',\n], function (pagination, infinitescroll, postTools, images, navigator, components, translator, hooks) {\n\tvar Posts = { };\n\n\tPosts.onNewPost = function (data) {\n\t\tif (\n\t\t\t!data ||\n\t\t\t!data.posts ||\n\t\t\t!data.posts.length ||\n\t\t\tparseInt(data.posts[0].tid, 10) !== parseInt(ajaxify.data.tid, 10)\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata.loggedIn = !!app.user.uid;\n\t\tdata.privileges = ajaxify.data.privileges;\n\n\t\t// if not a scheduled topic, prevent timeago in future by setting timestamp to 1 sec behind now\n\t\tdata.posts[0].timestamp = data.posts[0].topic.scheduled ? data.posts[0].timestamp : Date.now() - 1000;\n\t\tdata.posts[0].timestampISO = utils.toISOString(data.posts[0].timestamp);\n\n\t\tPosts.modifyPostsByPrivileges(data.posts);\n\n\t\tupdatePostCounts(data.posts);\n\n\t\tupdatePostIndices(data.posts);\n\n\t\tajaxify.data.postcount += 1;\n\t\tpostTools.updatePostCount(ajaxify.data.postcount);\n\n\t\tif (config.usePagination) {\n\t\t\tonNewPostPagination(data);\n\t\t} else {\n\t\t\tonNewPostInfiniteScroll(data);\n\t\t}\n\n\t\trequire(['forum/topic/replies'], function (replies) {\n\t\t\treplies.onNewPost(data);\n\t\t});\n\t};\n\n\tPosts.modifyPostsByPrivileges = function (posts) {\n\t\tposts.forEach(function (post) {\n\t\t\tpost.selfPost = !!app.user.uid && parseInt(post.uid, 10) === parseInt(app.user.uid, 10);\n\t\t\tpost.topicOwnerPost = parseInt(post.uid, 10) === parseInt(ajaxify.data.uid, 10);\n\n\t\t\tpost.display_edit_tools = (ajaxify.data.privileges['posts:edit'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\n\t\t\tpost.display_delete_tools = (ajaxify.data.privileges['posts:delete'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\n\t\t\tpost.display_moderator_tools = post.display_edit_tools || post.display_delete_tools;\n\t\t\tpost.display_move_tools = ajaxify.data.privileges.isAdminOrMod;\n\t\t\tpost.display_post_menu = ajaxify.data.privileges.isAdminOrMod ||\n\t\t\t\t(post.selfPost && !ajaxify.data.locked && !post.deleted) ||\n\t\t\t\t(post.selfPost && post.deleted && parseInt(post.deleterUid, 10) === parseInt(app.user.uid, 10)) ||\n\t\t\t\t((app.user.uid || ajaxify.data.postSharing.length) && !post.deleted);\n\t\t});\n\t};\n\n\tfunction updatePostCounts(posts) {\n\t\tfor (var i = 0; i < posts.length; i += 1) {\n\t\t\tvar cmp = components.get('user/postcount', posts[i].uid);\n\t\t\tcmp.html(parseInt(cmp.attr('data-postcount'), 10) + 1);\n\t\t\tutils.addCommasToNumbers(cmp);\n\t\t}\n\t}\n\n\tfunction updatePostIndices(posts) {\n\t\tif (config.topicPostSort === 'newest_to_oldest') {\n\t\t\tposts[0].index = 1;\n\t\t\tcomponents.get('post').not('[data-index=0]').each(function () {\n\t\t\t\tvar newIndex = parseInt($(this).attr('data-index'), 10) + 1;\n\t\t\t\t$(this).attr('data-index', newIndex);\n\t\t\t});\n\t\t}\n\t}\n\n\tfunction onNewPostPagination(data) {\n\t\tfunction scrollToPost() {\n\t\t\tscrollToPostIfSelf(data.posts[0]);\n\t\t}\n\n\t\tvar posts = data.posts;\n\n\t\tajaxify.data.pagination.pageCount = Math.max(1, Math.ceil(posts[0].topic.postcount / config.postsPerPage));\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\n\n\t\tvar isPostVisible = (\n\t\t\tajaxify.data.pagination.currentPage === ajaxify.data.pagination.pageCount &&\n\t\t\tdirection === 1\n\t\t) || (ajaxify.data.pagination.currentPage === 1 && direction === -1);\n\n\t\tif (isPostVisible) {\n\t\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, false, scrollToPost);\n\t\t} else if (ajaxify.data.scrollToMyPost && parseInt(posts[0].uid, 10) === parseInt(app.user.uid, 10)) {\n\t\t\t// https://github.com/NodeBB/NodeBB/issues/5004#issuecomment-247157441\n\t\t\tsetTimeout(function () {\n\t\t\t\tpagination.loadPage(ajaxify.data.pagination.pageCount, scrollToPost);\n\t\t\t}, 250);\n\t\t} else {\n\t\t\tupdatePagination();\n\t\t}\n\t}\n\n\tfunction updatePagination() {\n\t\t$.get(config.relative_path + '/api/topic/pagination/' + ajaxify.data.tid, { page: ajaxify.data.pagination.currentPage }, function (paginationData) {\n\t\t\tapp.parseAndTranslate('partials/paginator', paginationData, function (html) {\n\t\t\t\t$('[component=\"pagination\"]').after(html).remove();\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction onNewPostInfiniteScroll(data) {\n\t\tvar direction = (config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes') ? 1 : -1;\n\n\t\tvar isPreviousPostAdded = $('[component=\"post\"][data-index=\"' + (data.posts[0].index - 1) + '\"]').length;\n\t\tif (!isPreviousPostAdded && (!data.posts[0].selfPost || !ajaxify.data.scrollToMyPost)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!isPreviousPostAdded && data.posts[0].selfPost) {\n\t\t\treturn ajaxify.go('post/' + data.posts[0].pid);\n\t\t}\n\n\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, false, function (html) {\n\t\t\tif (html) {\n\t\t\t\thtml.addClass('new');\n\t\t\t}\n\t\t\tscrollToPostIfSelf(data.posts[0]);\n\t\t});\n\t}\n\n\tfunction scrollToPostIfSelf(post) {\n\t\tif (post.selfPost && ajaxify.data.scrollToMyPost) {\n\t\t\tnavigator.scrollBottom(post.index);\n\t\t}\n\t}\n\n\tfunction createNewPosts(data, repliesSelector, direction, userScrolled, callback) {\n\t\tcallback = callback || function () {};\n\t\tif (!data || (data.posts && !data.posts.length)) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tfunction removeAlreadyAddedPosts() {\n\t\t\tvar newPosts = $('[component=\"post\"].new');\n\n\t\t\tif (newPosts.length === data.posts.length) {\n\t\t\t\tvar allSamePids = true;\n\t\t\t\tnewPosts.each(function (index, el) {\n\t\t\t\t\tif (parseInt($(el).attr('data-pid'), 10) !== parseInt(data.posts[index].pid, 10)) {\n\t\t\t\t\t\tallSamePids = false;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tif (allSamePids) {\n\t\t\t\t\tnewPosts.each(function () {\n\t\t\t\t\t\t$(this).removeClass('new');\n\t\t\t\t\t});\n\t\t\t\t\tdata.posts.length = 0;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (newPosts.length && data.posts.length > 1) {\n\t\t\t\tdata.posts.forEach(function (post) {\n\t\t\t\t\tvar p = components.get('post', 'pid', post.pid);\n\t\t\t\t\tif (p.hasClass('new')) {\n\t\t\t\t\t\tp.remove();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdata.posts = data.posts.filter(function (post) {\n\t\t\t\treturn $('[component=\"post\"][data-pid=\"' + post.pid + '\"]').length === 0;\n\t\t\t});\n\t\t}\n\n\t\tremoveAlreadyAddedPosts();\n\n\t\tif (!data.posts.length) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tvar after;\n\t\tvar before;\n\n\t\tif (direction > 0 && repliesSelector.length) {\n\t\t\tafter = repliesSelector.last();\n\t\t} else if (direction < 0 && repliesSelector.length) {\n\t\t\tbefore = repliesSelector.first();\n\t\t}\n\n\t\t$(window).trigger('action:posts.loading', { posts: data.posts, after: after, before: before });\n\n\t\tapp.parseAndTranslate('topic', 'posts', Object.assign({}, ajaxify.data, data), function (html) {\n\t\t\thtml = html.filter(function () {\n\t\t\t\tvar pid = $(this).attr('data-pid');\n\t\t\t\treturn pid && $('[component=\"post\"][data-pid=\"' + pid + '\"]').length === 0;\n\t\t\t});\n\n\t\t\tif (after) {\n\t\t\t\thtml.insertAfter(after);\n\t\t\t} else if (before) {\n\t\t\t\t// Save document height and position for future reference (about 5 lines down)\n\t\t\t\tvar height = $(document).height();\n\t\t\t\tvar scrollTop = $(window).scrollTop();\n\n\t\t\t\thtml.insertBefore(before);\n\n\t\t\t\t// Now restore the relative position the user was on prior to new post insertion\n\t\t\t\tif (userScrolled || scrollTop > 0) {\n\t\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tcomponents.get('topic').append(html);\n\t\t\t}\n\n\t\t\tinfinitescroll.removeExtra($('[component=\"post\"]'), direction, Math.max(20, config.postsPerPage * 2));\n\n\t\t\thooks.fire('action:posts.loaded', { posts: data.posts });\n\n\t\t\tPosts.onNewPostsAddedToDom(html);\n\n\t\t\tcallback(html);\n\t\t});\n\t}\n\n\tPosts.loadMorePosts = function (direction) {\n\t\tif (!components.get('topic').length || navigator.scrollActive) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar replies = components.get('topic').find(components.get('post').not('[data-index=0]').not('.new'));\n\t\tvar afterEl = direction > 0 ? replies.last() : replies.first();\n\t\tvar after = parseInt(afterEl.attr('data-index'), 10) || 0;\n\n\t\tvar tid = ajaxify.data.tid;\n\t\tif (!utils.isNumber(tid) || !utils.isNumber(after) || (direction < 0 && components.get('post', 'index', 0).length)) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar indicatorEl = $('.loading-indicator');\n\t\tif (!indicatorEl.is(':animated')) {\n\t\t\tindicatorEl.fadeIn();\n\t\t}\n\n\t\tinfinitescroll.loadMore('topics.loadMore', {\n\t\t\ttid: tid,\n\t\t\tafter: after,\n\t\t\tcount: config.postsPerPage,\n\t\t\tdirection: direction,\n\t\t\ttopicPostSort: config.topicPostSort,\n\t\t}, function (data, done) {\n\t\t\tindicatorEl.fadeOut();\n\n\t\t\tif (data && data.posts && data.posts.length) {\n\t\t\t\tcreateNewPosts(data, replies, direction, true, done);\n\t\t\t} else {\n\t\t\t\tnavigator.update();\n\t\t\t\tdone();\n\t\t\t}\n\t\t});\n\t};\n\n\tPosts.onTopicPageLoad = function (posts) {\n\t\thandlePrivateUploads(posts);\n\t\timages.wrapImagesInLinks(posts);\n\t\tPosts.showBottomPostBar();\n\t\tposts.find('[component=\"post/content\"] img:not(.not-responsive)').addClass('img-responsive');\n\t\tPosts.addBlockquoteEllipses(posts);\n\t\thidePostToolsForDeletedPosts(posts);\n\t\tPosts.addTopicEvents();\n\t\taddNecroPostMessage();\n\t};\n\n\tPosts.addTopicEvents = function (events) {\n\t\tevents = events || ajaxify.data.events;\n\t\tif (!events || !Array.isArray(events)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (config.topicPostSort !== 'newest_to_oldest' && config.topicPostSort !== 'oldest_to_newest') {\n\t\t\treturn;\n\t\t}\n\n\t\t// Filter out events already in DOM\n\t\tconst eventIdsInDOM = Array.from(document.querySelectorAll('[component=\"topic/event\"]')).map(el => parseInt(el.getAttribute('data-topic-event-id'), 10));\n\t\tevents = events.filter(event => !eventIdsInDOM.includes(event.id));\n\n\t\tlet postTimestamps = ajaxify.data.posts.map(post => post.timestamp);\n\n\t\tconst reverse = config.topicPostSort === 'newest_to_oldest';\n\t\tevents = events.slice(0);\n\t\tif (reverse) {\n\t\t\tevents.reverse();\n\t\t\tpostTimestamps = postTimestamps.slice(1);\t// OP is always at top, so exclude from calculations\n\t\t}\n\n\t\tPromise.all(events.map((event) => {\n\t\t\tconst beforeIdx = postTimestamps.findIndex(\n\t\t\t\ttimestamp => (reverse ? (timestamp < event.timestamp) : (timestamp > event.timestamp))\n\t\t\t);\n\t\t\tlet postEl;\n\t\t\tif (beforeIdx > -1) {\n\t\t\t\tpostEl = document.querySelector(`[component=\"post\"][data-pid=\"${ajaxify.data.posts[beforeIdx + (reverse ? 1 : 0)].pid}\"]`);\n\t\t\t}\n\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tapp.parseAndTranslate('partials/topic/event', event, function (html) {\n\t\t\t\t\thtml = html.get(0);\n\n\t\t\t\t\tif (postEl) {\n\t\t\t\t\t\tdocument.querySelector('[component=\"topic\"]').insertBefore(html, postEl);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdocument.querySelector('[component=\"topic\"]').append(html);\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t});\n\t\t})).then(() => {\n\t\t\t$('[component=\"topic/event\"] .timeago').timeago();\n\t\t});\n\t};\n\n\tfunction addNecroPostMessage() {\n\t\tvar necroThreshold = ajaxify.data.necroThreshold * 24 * 60 * 60 * 1000;\n\t\tif (!necroThreshold || (config.topicPostSort !== 'newest_to_oldest' && config.topicPostSort !== 'oldest_to_newest')) {\n\t\t\treturn;\n\t\t}\n\n\t\t$('[component=\"post\"]').each(function () {\n\t\t\tvar post = $(this);\n\t\t\tvar prev = post.prev('[component=\"post\"]');\n\t\t\tif (post.is(':has(.necro-post)') || !prev.length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (config.topicPostSort === 'newest_to_oldest' && parseInt(prev.attr('data-index'), 10) === 0) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar diff = post.attr('data-timestamp') - prev.attr('data-timestamp');\n\t\t\tif (Math.abs(diff) >= necroThreshold) {\n\t\t\t\tvar suffixAgo = $.timeago.settings.strings.suffixAgo;\n\t\t\t\tvar prefixAgo = $.timeago.settings.strings.prefixAgo;\n\t\t\t\tvar suffixFromNow = $.timeago.settings.strings.suffixFromNow;\n\t\t\t\tvar prefixFromNow = $.timeago.settings.strings.prefixFromNow;\n\n\t\t\t\t$.timeago.settings.strings.suffixAgo = '';\n\t\t\t\t$.timeago.settings.strings.prefixAgo = '';\n\t\t\t\t$.timeago.settings.strings.suffixFromNow = '';\n\t\t\t\t$.timeago.settings.strings.prefixFromNow = '';\n\n\t\t\t\tvar translationText = (diff > 0 ? '[[topic:timeago_later,' : '[[topic:timeago_earlier,') + $.timeago.inWords(diff) + ']]';\n\n\t\t\t\t$.timeago.settings.strings.suffixAgo = suffixAgo;\n\t\t\t\t$.timeago.settings.strings.prefixAgo = prefixAgo;\n\t\t\t\t$.timeago.settings.strings.suffixFromNow = suffixFromNow;\n\t\t\t\t$.timeago.settings.strings.prefixFromNow = prefixFromNow;\n\t\t\t\tapp.parseAndTranslate('partials/topic/necro-post', { text: translationText }, function (html) {\n\t\t\t\t\thtml.insertBefore(post);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction handlePrivateUploads(posts) {\n\t\tif (app.user.uid || !ajaxify.data.privateUploads) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Replace all requests for uploaded images/files with a login link\n\t\tvar loginEl = document.createElement('a');\n\t\tloginEl.className = 'login-required';\n\t\tloginEl.href = config.relative_path + '/login';\n\n\t\ttranslator.translate('[[topic:login-to-view]]', function (translated) {\n\t\t\tloginEl.appendChild(document.createTextNode(translated));\n\t\t\tposts.each(function (idx, postEl) {\n\t\t\t\t$(postEl).find('[component=\"post/content\"] img').each(function (idx, imgEl) {\n\t\t\t\t\timgEl = $(imgEl);\n\t\t\t\t\tif (imgEl.attr('src').startsWith(config.relative_path + config.upload_url)) {\n\t\t\t\t\t\timgEl.replaceWith(loginEl.cloneNode(true));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tPosts.onNewPostsAddedToDom = function (posts) {\n\t\tPosts.onTopicPageLoad(posts);\n\n\t\tapp.createUserTooltips(posts);\n\n\t\tutils.addCommasToNumbers(posts.find('.formatted-number'));\n\t\tutils.makeNumbersHumanReadable(posts.find('.human-readable-number'));\n\t\tposts.find('.timeago').timeago();\n\t};\n\n\tPosts.showBottomPostBar = function () {\n\t\tvar mainPost = components.get('post', 'index', 0);\n\t\tvar placeHolder = $('.post-bar-placeholder');\n\t\tvar posts = $('[component=\"post\"]');\n\t\tif (!!mainPost.length && posts.length > 1 && $('.post-bar').length < 2 && placeHolder.length) {\n\t\t\t$('.post-bar').clone().insertAfter(placeHolder);\n\t\t\tplaceHolder.remove();\n\t\t} else if (mainPost.length && posts.length < 2) {\n\t\t\tmainPost.find('.post-bar').remove();\n\t\t}\n\t};\n\n\tfunction hidePostToolsForDeletedPosts(posts) {\n\t\tposts.each(function () {\n\t\t\tif ($(this).hasClass('deleted')) {\n\t\t\t\tpostTools.toggle($(this).attr('data-pid'), true);\n\t\t\t}\n\t\t});\n\t}\n\n\tPosts.addBlockquoteEllipses = function (posts) {\n\t\tvar blockquotes = posts.find('[component=\"post/content\"] > blockquote > blockquote');\n\t\tblockquotes.each(function () {\n\t\t\tvar $this = $(this);\n\t\t\tif ($this.find(':hidden:not(br)').length && !$this.find('.toggle').length) {\n\t\t\t\t$this.append('<i class=\"fa fa-angle-down pointer toggle\"></i>');\n\t\t\t}\n\t\t});\n\t};\n\n\treturn Posts;\n});\n"]}