{"version":3,"sources":["public/src/client/topic/votes.js"],"names":["define","components","translator","Benchpress","api","Votes","addVoteHandler","get","on","loadDataAndCreateTooltip","e","stopPropagation","$this","$","this","el","parent","find","css","pid","parents","attr","socket","emit","err","data","app","alertError","message","length","createTooltip","doCreateTooltip","title","tooltip","usernames","filter","name","otherCount","join","replace","translate","translated","toggleVote","button","className","delta","post","closest","currentState","method","ajaxify","go","window","trigger","unvote","showVotes","cid","parseAndTranslate","html","dialog","bootbox","show","modal"],"mappings":"AAAA,aAGAA,OAAO,qBACN,aAAc,aAAc,aAAc,OACxC,SAAUC,EAAYC,EAAYC,EAAYC,GAChD,IAAIC,KAEJA,EAAMC,eAAiB,WACtBL,EAAWM,IAAI,SAASC,GAAG,aAAc,2CAA4CC,IAGtF,SAASA,EAAyBC,GACjCA,EAAEC,kBAEF,IAAIC,EAAQC,EAAEC,MACd,IAAIC,EAAKH,EAAMI,SACfD,EAAGE,KAAK,YAAYC,IAAI,UAAW,QACnC,IAAIC,EAAMJ,EAAGK,QAAQ,cAAcC,KAAK,YAExCC,OAAOC,KAAK,qBAAsBJ,GAAM,SAAUK,EAAKC,GACtD,GAAID,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3B,GAAIH,EAAKI,OAAQ,CAChBC,EAAclB,EAAOa,EAAK,OAG5B,OAAO,MAGR,SAASK,EAAcf,EAAIU,GAC1B,SAASM,EAAgBC,GACxBjB,EAAGM,KAAK,QAASW,GAAOC,QAAQ,YAAYA,QAAQ,QACpDlB,EAAGC,SAASC,KAAK,YAAYC,IAAI,UAAW,IAE7C,IAAIgB,EAAYT,EAAKS,UACnBC,OAAOC,GAAQA,IAAS,0BAC1B,IAAKF,EAAUL,OAAQ,CACtB,OAED,GAAIK,EAAUL,OAASJ,EAAKY,WAAa,EAAG,CAC3CH,EAAYA,EAAUI,KAAK,MAAMC,QAAQ,KAAM,KAC/CrC,EAAWsC,UAAU,6BAA+BN,EAAY,KAAOT,EAAKY,WAAa,KAAM,SAAUI,GACxGA,EAAaA,EAAWF,QAAQ,MAAO,KACvCR,EAAgBU,SAEX,CACNP,EAAYA,EAAUI,KAAK,MAC3BP,EAAgBG,IAKlB7B,EAAMqC,WAAa,SAAUC,EAAQC,EAAWC,GAC/C,IAAIC,EAAOH,EAAOI,QAAQ,cAC1B,IAAIC,EAAeF,EAAK7B,KAAK2B,GAAWf,OAExC,MAAMoB,EAASD,EAAe,MAAQ,MACtC,IAAI7B,EAAM2B,EAAKzB,KAAK,YACpBjB,EAAI6C,aAAkB9B,UACrB0B,MAAOA,GACL,SAAUrB,GACZ,GAAIA,EAAK,CAER,GAAIA,EAAII,UAAY,oEAAqE,CACxFsB,QAAQC,GAAG,SACX,OAED,OAAOzB,IAAIC,WAAWH,EAAII,SAE3Bf,EAAEuC,QAAQC,QAAQ,0BACjBlC,IAAKA,EACL0B,MAAOA,EACPS,OAAQL,IAAW,UAIrB,OAAO,OAGR5C,EAAMkD,UAAY,SAAUpC,GAC3BG,OAAOC,KAAK,mBAAqBJ,IAAKA,EAAKqC,IAAKN,QAAQzB,KAAK+B,KAAO,SAAUhC,EAAKC,GAClF,GAAID,EAAK,CACR,GAAIA,EAAII,UAAY,0BAA2B,CAC9C,OAID,OAAOF,IAAIC,WAAWH,EAAII,SAG3BF,IAAI+B,kBAAkB,8BAA+BhC,EAAM,SAAUiC,GACpE,IAAIC,EAASC,QAAQD,QACpB3B,MAAO,oBACPJ,QAAS8B,EACTd,UAAW,aACXiB,KAAM,OAGPF,EAAOnD,GAAG,QAAS,WAClBmD,EAAOG,MAAM,eAOjB,OAAOzD","file":"public/src/client/topic/votes.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/votes', [\n\t'components', 'translator', 'benchpress', 'api',\n], function (components, translator, Benchpress, api) {\n\tvar Votes = {};\n\n\tVotes.addVoteHandler = function () {\n\t\tcomponents.get('topic').on('mouseenter', '[data-pid] [component=\"post/vote-count\"]', loadDataAndCreateTooltip);\n\t};\n\n\tfunction loadDataAndCreateTooltip(e) {\n\t\te.stopPropagation();\n\n\t\tvar $this = $(this);\n\t\tvar el = $this.parent();\n\t\tel.find('.tooltip').css('display', 'none');\n\t\tvar pid = el.parents('[data-pid]').attr('data-pid');\n\n\t\tsocket.emit('posts.getUpvoters', [pid], function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (data.length) {\n\t\t\t\tcreateTooltip($this, data[0]);\n\t\t\t}\n\t\t});\n\t\treturn false;\n\t}\n\n\tfunction createTooltip(el, data) {\n\t\tfunction doCreateTooltip(title) {\n\t\t\tel.attr('title', title).tooltip('fixTitle').tooltip('show');\n\t\t\tel.parent().find('.tooltip').css('display', '');\n\t\t}\n\t\tvar usernames = data.usernames\n\t\t\t.filter(name => name !== '[[global:former_user]]');\n\t\tif (!usernames.length) {\n\t\t\treturn;\n\t\t}\n\t\tif (usernames.length + data.otherCount > 6) {\n\t\t\tusernames = usernames.join(', ').replace(/,/g, '|');\n\t\t\ttranslator.translate('[[topic:users_and_others, ' + usernames + ', ' + data.otherCount + ']]', function (translated) {\n\t\t\t\ttranslated = translated.replace(/\\|/g, ',');\n\t\t\t\tdoCreateTooltip(translated);\n\t\t\t});\n\t\t} else {\n\t\t\tusernames = usernames.join(', ');\n\t\t\tdoCreateTooltip(usernames);\n\t\t}\n\t}\n\n\n\tVotes.toggleVote = function (button, className, delta) {\n\t\tvar post = button.closest('[data-pid]');\n\t\tvar currentState = post.find(className).length;\n\n\t\tconst method = currentState ? 'del' : 'put';\n\t\tvar pid = post.attr('data-pid');\n\t\tapi[method](`/posts/${pid}/vote`, {\n\t\t\tdelta: delta,\n\t\t}, function (err) {\n\t\t\tif (err) {\n\t\t\t\t// TODO: err.message is currently hardcoded in helpers/api.js\n\t\t\t\tif (err.message === 'A valid login session was not found. Please log in and try again.') {\n\t\t\t\t\tajaxify.go('login');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\t$(window).trigger('action:post.toggleVote', {\n\t\t\t\tpid: pid,\n\t\t\t\tdelta: delta,\n\t\t\t\tunvote: method === 'del',\n\t\t\t});\n\t\t});\n\n\t\treturn false;\n\t};\n\n\tVotes.showVotes = function (pid) {\n\t\tsocket.emit('posts.getVoters', { pid: pid, cid: ajaxify.data.cid }, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\tif (err.message === '[[error:no-privileges]]') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Only show error if it's an unexpected error.\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tapp.parseAndTranslate('partials/modals/votes_modal', data, function (html) {\n\t\t\t\tvar dialog = bootbox.dialog({\n\t\t\t\t\ttitle: '[[global:voters]]',\n\t\t\t\t\tmessage: html,\n\t\t\t\t\tclassName: 'vote-modal',\n\t\t\t\t\tshow: true,\n\t\t\t\t});\n\n\t\t\t\tdialog.on('click', function () {\n\t\t\t\t\tdialog.modal('hide');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\n\treturn Votes;\n});\n"]}