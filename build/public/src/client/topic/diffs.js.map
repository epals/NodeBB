{"version":3,"sources":["public/src/client/topic/diffs.js"],"names":["define","api","bootbox","Diffs","localeStringOpts","year","month","day","hour","minute","open","pid","config","enablePostHistory","get","then","data","parsePostHistory","$html","$modal","dialog","title","message","size","timestamps","length","$selectEl","find","$revertEl","$deleteEl","$postContainer","$numberOfDiffCon","on","load","this","value","prop","indexOf","restore","val","delete","catch","app","alertError","since","deleted","parseInt","parseAndTranslate","posts","empty","append","put","modal","alertSuccess","timestamp","del","trigger","numberOfDiffs","text","blockName","Promise","resolve","params","diffs","revisions","map","revision","username","pretty","Date","toLocaleString","userLang","replace","numDiffs","editable","deletable","unshift"],"mappings":"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","file":"public/src/client/topic/diffs.js","sourcesContent":["'use strict';\n\ndefine('forum/topic/diffs', ['api', 'bootbox', 'forum/topic/images'], function (api, bootbox) {\n\tconst Diffs = {};\n\tconst localeStringOpts = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' };\n\n\tDiffs.open = function (pid) {\n\t\tif (!config.enablePostHistory) {\n\t\t\treturn;\n\t\t}\n\n\t\tapi.get(`/posts/${pid}/diffs`, {}).then((data) => {\n\t\t\tparsePostHistory(data).then(($html) => {\n\t\t\t\tconst $modal = bootbox.dialog({ title: '[[topic:diffs.title]]', message: $html, size: 'large' });\n\n\t\t\t\tif (!data.timestamps.length) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst $selectEl = $modal.find('select');\n\t\t\t\tconst $revertEl = $modal.find('button[data-action=\"restore\"]');\n\t\t\t\tconst $deleteEl = $modal.find('button[data-action=\"delete\"]');\n\t\t\t\tconst $postContainer = $modal.find('ul.posts-list');\n\t\t\t\tconst $numberOfDiffCon = $modal.find('.number-of-diffs strong');\n\n\t\t\t\t$selectEl.on('change', function () {\n\t\t\t\t\tDiffs.load(pid, this.value, $postContainer);\n\t\t\t\t\t$revertEl.prop('disabled', data.timestamps.indexOf(this.value) === 0);\n\t\t\t\t\t$deleteEl.prop('disabled', data.timestamps.indexOf(this.value) === 0);\n\t\t\t\t});\n\n\t\t\t\t$revertEl.on('click', function () {\n\t\t\t\t\tDiffs.restore(pid, $selectEl.val(), $modal);\n\t\t\t\t});\n\n\t\t\t\t$deleteEl.on('click', function () {\n\t\t\t\t\tDiffs.delete(pid, $selectEl.val(), $selectEl, $numberOfDiffCon);\n\t\t\t\t});\n\n\t\t\t\t$modal.on('shown.bs.modal', function () {\n\t\t\t\t\tDiffs.load(pid, $selectEl.val(), $postContainer);\n\t\t\t\t\t$revertEl.prop('disabled', true);\n\t\t\t\t\t$deleteEl.prop('disabled', true);\n\t\t\t\t});\n\t\t\t});\n\t\t}).catch(app.alertError);\n\t};\n\n\tDiffs.load = function (pid, since, $postContainer) {\n\t\tif (!config.enablePostHistory) {\n\t\t\treturn;\n\t\t}\n\n\t\tapi.get(`/posts/${pid}/diffs/${since}`, {}).then((data) => {\n\t\t\tdata.deleted = !!parseInt(data.deleted, 10);\n\n\t\t\tapp.parseAndTranslate('partials/posts_list', 'posts', {\n\t\t\t\tposts: [data],\n\t\t\t}, function ($html) {\n\t\t\t\t$postContainer.empty().append($html);\n\t\t\t});\n\t\t}).catch(app.alertError);\n\t};\n\n\tDiffs.restore = function (pid, since, $modal) {\n\t\tif (!config.enablePostHistory) {\n\t\t\treturn;\n\t\t}\n\n\t\tapi.put(`/posts/${pid}/diffs/${since}`, {}).then(() => {\n\t\t\t$modal.modal('hide');\n\t\t\tapp.alertSuccess('[[topic:diffs.post-restored]]');\n\t\t}).catch(app.alertError);\n\t};\n\n\tDiffs.delete = function (pid, timestamp, $selectEl, $numberOfDiffCon) {\n\t\tapi.del(`/posts/${pid}/diffs/${timestamp}`).then((data) => {\n\t\t\tparsePostHistory(data, 'diffs').then(($html) => {\n\t\t\t\t$selectEl.empty().append($html);\n\t\t\t\t$selectEl.trigger('change');\n\t\t\t\tconst numberOfDiffs = $selectEl.find('option').length;\n\t\t\t\t$numberOfDiffCon.text(numberOfDiffs);\n\t\t\t\tapp.alertSuccess('[[topic:diffs.deleted]]');\n\t\t\t});\n\t\t}).catch(app.alertError);\n\t};\n\n\tfunction parsePostHistory(data, blockName) {\n\t\treturn new Promise((resolve) => {\n\t\t\tconst params = [{\n\t\t\t\tdiffs: data.revisions.map(function (revision) {\n\t\t\t\t\tconst timestamp = parseInt(revision.timestamp, 10);\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tusername: revision.username,\n\t\t\t\t\t\ttimestamp: timestamp,\n\t\t\t\t\t\tpretty: new Date(timestamp).toLocaleString(config.userLang.replace('_', '-'), localeStringOpts),\n\t\t\t\t\t};\n\t\t\t\t}),\n\t\t\t\tnumDiffs: data.timestamps.length,\n\t\t\t\teditable: data.editable,\n\t\t\t\tdeletable: data.deletable,\n\t\t\t}, function ($html) {\n\t\t\t\tresolve($html);\n\t\t\t}];\n\n\t\t\tif (blockName) {\n\t\t\t\tparams.unshift(blockName);\n\t\t\t}\n\n\t\t\tapp.parseAndTranslate('partials/modals/post_history', ...params);\n\t\t});\n\t}\n\n\treturn Diffs;\n});\n"]}