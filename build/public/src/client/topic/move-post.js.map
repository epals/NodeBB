{"version":3,"sources":["public/src/client/topic/move-post.js"],"names":["define","components","postSelect","translator","alerts","api","MovePost","moveModal","moveCommit","fromTid","init","postEl","ajaxify","data","tid","app","parseAndTranslate","html","find","$","append","on","closeMoveModal","utils","debounce","checkMoveButtonEnable","onPostToggled","showPostsSelected","togglePostSelection","attr","window","off","onAjaxifyEnd","targetTid","getTargetTid","pids","slice","alert","alert_id","join","title","message","type","timeout","timeoutfn","movePosts","clickfn","params","alertSuccess","removeAttr","tidInput","template","topic","parseInt","val","length","get","then","alertError","scheduled","translateStr","compile","translateHtml","Promise","all","map","pid","put","forEach","fadeOut","this","remove","catch","disable"],"mappings":"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","file":"public/src/client/topic/move-post.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/move-post', [\n\t'components', 'postSelect', 'translator', 'alerts', 'api',\n], function (components, postSelect, translator, alerts, api) {\n\tvar MovePost = {};\n\n\tvar moveModal;\n\tvar moveCommit;\n\tvar fromTid;\n\n\tMovePost.init = function (postEl) {\n\t\tif (moveModal) {\n\t\t\treturn;\n\t\t}\n\t\tfromTid = ajaxify.data.tid;\n\t\tapp.parseAndTranslate('modals/move-post', {}, function (html) {\n\t\t\tmoveModal = html;\n\n\t\t\tmoveCommit = moveModal.find('#move_posts_confirm');\n\n\t\t\t$('body').append(moveModal);\n\n\t\t\tmoveModal.find('.close,#move_posts_cancel').on('click', closeMoveModal);\n\t\t\tmoveModal.find('#topicId').on('keyup', utils.debounce(checkMoveButtonEnable, 200));\n\t\t\tpostSelect.init(onPostToggled);\n\t\t\tshowPostsSelected();\n\n\t\t\tif (postEl) {\n\t\t\t\tpostSelect.togglePostSelection(postEl, postEl.attr('data-pid'));\n\t\t\t}\n\n\t\t\t$(window).off('action:ajaxify.end', onAjaxifyEnd)\n\t\t\t\t.on('action:ajaxify.end', onAjaxifyEnd);\n\n\t\t\tmoveCommit.on('click', function () {\n\t\t\t\tconst targetTid = getTargetTid();\n\t\t\t\tif (!targetTid) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tmoveCommit.attr('disabled', true);\n\t\t\t\tvar data = {\n\t\t\t\t\tpids: postSelect.pids.slice(),\n\t\t\t\t\ttid: targetTid,\n\t\t\t\t};\n\t\t\t\talerts.alert({\n\t\t\t\t\talert_id: 'pids_move_' + postSelect.pids.join('-'),\n\t\t\t\t\ttitle: '[[topic:thread_tools.move-posts]]',\n\t\t\t\t\tmessage: '[[topic:topic_move_posts_success]]',\n\t\t\t\t\ttype: 'success',\n\t\t\t\t\ttimeout: 10000,\n\t\t\t\t\ttimeoutfn: function () {\n\t\t\t\t\t\tmovePosts(data);\n\t\t\t\t\t},\n\t\t\t\t\tclickfn: function (alert, params) {\n\t\t\t\t\t\tdelete params.timeoutfn;\n\t\t\t\t\t\tapp.alertSuccess('[[topic:topic_move_posts_undone]]');\n\t\t\t\t\t\tmoveCommit.removeAttr('disabled');\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tfunction onAjaxifyEnd() {\n\t\tif (!moveModal) {\n\t\t\treturn;\n\t\t}\n\t\tvar tidInput = moveModal.find('#topicId');\n\t\tvar targetTid = null;\n\t\tif (ajaxify.data.template.topic && ajaxify.data.tid &&\n\t\t\tparseInt(ajaxify.data.tid, 10) !== fromTid\n\t\t) {\n\t\t\ttargetTid = ajaxify.data.tid;\n\t\t}\n\t\tif (targetTid && !tidInput.val()) {\n\t\t\ttidInput.val(targetTid);\n\t\t}\n\t\tcheckMoveButtonEnable();\n\t}\n\n\tfunction getTargetTid() {\n\t\tvar tidInput = moveModal.find('#topicId');\n\t\tif (tidInput.length && tidInput.val()) {\n\t\t\treturn tidInput.val();\n\t\t}\n\t\treturn ajaxify.data.template.topic && ajaxify.data.tid;\n\t}\n\n\tfunction showPostsSelected() {\n\t\tif (!moveModal) {\n\t\t\treturn;\n\t\t}\n\t\tvar targetTid = getTargetTid();\n\t\tif (postSelect.pids.length) {\n\t\t\tif (targetTid && parseInt(targetTid, 10) !== parseInt(fromTid, 10)) {\n\t\t\t\tapi.get('/topics/' + targetTid, {}).then(function (data) {\n\t\t\t\t\tif (!data || !data.tid) {\n\t\t\t\t\t\treturn app.alertError('[[error:no-topic]]');\n\t\t\t\t\t}\n\t\t\t\t\tif (data.scheduled) {\n\t\t\t\t\t\treturn app.alertError('[[error:cant-move-posts-to-scheduled]]');\n\t\t\t\t\t}\n\t\t\t\t\tvar translateStr = translator.compile('topic:x-posts-will-be-moved-to-y', postSelect.pids.length, data.title);\n\t\t\t\t\tmoveModal.find('#pids').translateHtml(translateStr);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tmoveModal.find('#pids').translateHtml('[[topic:x-posts-selected, ' + postSelect.pids.length + ']]');\n\t\t\t}\n\t\t} else {\n\t\t\tmoveModal.find('#pids').translateHtml('[[topic:no-posts-selected]]');\n\t\t}\n\t}\n\n\tfunction checkMoveButtonEnable() {\n\t\tif (!moveModal) {\n\t\t\treturn;\n\t\t}\n\t\tvar targetTid = getTargetTid();\n\t\tif (postSelect.pids.length && targetTid &&\n\t\t\tparseInt(targetTid, 10) !== parseInt(fromTid, 10)\n\t\t) {\n\t\t\tmoveCommit.removeAttr('disabled');\n\t\t} else {\n\t\t\tmoveCommit.attr('disabled', true);\n\t\t}\n\t\tshowPostsSelected();\n\t}\n\n\tfunction onPostToggled() {\n\t\tcheckMoveButtonEnable();\n\t}\n\n\tfunction movePosts(data) {\n\t\tif (!data.tid) {\n\t\t\treturn;\n\t\t}\n\n\t\tPromise.all(data.pids.map(pid => api.put(`/posts/${pid}/move`, {\n\t\t\ttid: data.tid,\n\t\t}))).then(() => {\n\t\t\tdata.pids.forEach(function (pid) {\n\t\t\t\tcomponents.get('post', 'pid', pid).fadeOut(500, function () {\n\t\t\t\t\t$(this).remove();\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tcloseMoveModal();\n\t\t}).catch(app.alertError);\n\t}\n\n\tfunction closeMoveModal() {\n\t\tif (moveModal) {\n\t\t\tmoveModal.remove();\n\t\t\tmoveModal = null;\n\t\t\tpostSelect.disable();\n\t\t\t$(window).off('action:ajaxify.end', onAjaxifyEnd);\n\t\t}\n\t}\n\n\treturn MovePost;\n});\n"]}