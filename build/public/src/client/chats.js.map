{"version":3,"sources":["public/src/client/chats.js"],"names":["define","components","translator","mousetrap","recentChats","search","messages","Benchpress","autocomplete","Chats","initialised","newMessage","init","env","utils","findBootstrapEnvironment","addSocketListeners","addGlobalEventListeners","addEventListeners","resizeMainWindow","addHotkeys","$","document","ready","window","trigger","scrollToBottom","ajaxify","data","hasOwnProperty","get","focus","addSendHandlers","roomId","addPopoutHandler","addActionHandlers","addMemberHandler","find","addRenameHandler","addLeaveHandler","addScrollHandler","uid","addScrollBottomHandler","addCharactersLeftHandler","addIPHandler","createAutoComplete","on","switchChat","container","ipEl","this","parent","mid","parents","attr","socket","emit","err","ip","app","alertError","html","text","val","previousUrl","match","go","userslug","openChat","history","one","el","loading","off","toggleScrollUpAlert","top","scrollHeight","height","scrollTop","start","parseInt","children","length","message","filter","chatMsg","messageId","parseMessage","currentScrollTop","previousHeight","prepend","timeago","addClass","chatContent","element","updateRemainingLength","action","getAttribute","inputEl","prepEdit","delete","restore","bind","activeContact","prev","next","e","target","last","lastMid","buttonEl","modal","parseAndTranslate","bootbox","dialog","title","refreshParticipantsList","addKickHandler","searchInput","errorEl","require","user","event","selected","username","item","name","translate","translated","confirm","size","callback","ok","chatLib","close","users","listEl","roomName","buttons","save","label","className","submit","newName","sendEl","which","shiftKey","sendMessage","strategies","options","style","z-index","flex","placement","setup","leave","remove","chat","getModal","roomid","url","location","self","fetch","config","relative_path","credentials","then","response","json","payload","setActive","pushState","protocol","host","console","warn","status","catch","error","appendChatMessage","template","chats","roomEl","recentEl","rooms","lastUser","fromUser","usernames","unread","updateUserStatus","titleEl","viewportHeight","mainWrapper","navWrapper","fromTop","offset","toggleClass","removeClass"],"mappings":"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","file":"public/src/client/chats.js","sourcesContent":["'use strict';\n\n\ndefine('forum/chats', [\n\t'components',\n\t'translator',\n\t'mousetrap',\n\t'forum/chats/recent',\n\t'forum/chats/search',\n\t'forum/chats/messages',\n\t'benchpress',\n\t'composer/autocomplete',\n], function (components, translator, mousetrap, recentChats, search, messages, Benchpress, autocomplete) {\n\tvar Chats = {\n\t\tinitialised: false,\n\t};\n\n\tvar newMessage = false;\n\n\tChats.init = function () {\n\t\tvar env = utils.findBootstrapEnvironment();\n\n\t\tif (!Chats.initialised) {\n\t\t\tChats.addSocketListeners();\n\t\t\tChats.addGlobalEventListeners();\n\t\t}\n\n\t\trecentChats.init();\n\n\t\tChats.addEventListeners();\n\t\tChats.resizeMainWindow();\n\n\t\tif (env === 'md' || env === 'lg') {\n\t\t\tChats.addHotkeys();\n\t\t}\n\n\t\t$(document).ready(function () {\n\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t});\n\n\t\tChats.initialised = true;\n\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\n\t\tsearch.init();\n\n\t\tif (ajaxify.data.hasOwnProperty('roomId')) {\n\t\t\tcomponents.get('chat/input').focus();\n\t\t}\n\t};\n\n\tChats.addEventListeners = function () {\n\t\tChats.addSendHandlers(ajaxify.data.roomId, $('.chat-input'), $('.expanded-chat button[data-action=\"send\"]'));\n\t\tChats.addPopoutHandler();\n\t\tChats.addActionHandlers(components.get('chat/messages'), ajaxify.data.roomId);\n\t\tChats.addMemberHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"members\"]'));\n\t\tChats.addRenameHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"rename\"]'));\n\t\tChats.addLeaveHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"leave\"]'));\n\t\tChats.addScrollHandler(ajaxify.data.roomId, ajaxify.data.uid, $('.chat-content'));\n\t\tChats.addScrollBottomHandler($('.chat-content'));\n\t\tChats.addCharactersLeftHandler($('[component=\"chat/main-wrapper\"]'));\n\t\tChats.addIPHandler($('[component=\"chat/main-wrapper\"]'));\n\t\tChats.createAutoComplete($('[component=\"chat/input\"]'));\n\n\t\t$('[data-action=\"close\"]').on('click', function () {\n\t\t\tChats.switchChat();\n\t\t});\n\t};\n\n\tChats.addIPHandler = function (container) {\n\t\tcontainer.on('click', '.chat-ip-button', function () {\n\t\t\tvar ipEl = $(this).parent();\n\t\t\tvar mid = ipEl.parents('[data-mid]').attr('data-mid');\n\t\t\tsocket.emit('modules.chats.getIP', mid, function (err, ip) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tipEl.html(ip);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addPopoutHandler = function () {\n\t\t$('[data-action=\"pop-out\"]').on('click', function () {\n\t\t\tvar text = components.get('chat/input').val();\n\t\t\tvar roomId = ajaxify.data.roomId;\n\n\t\t\tif (app.previousUrl && app.previousUrl.match(/chats/)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats', function () {\n\t\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t\t}, true);\n\t\t\t} else {\n\t\t\t\twindow.history.go(-1);\n\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t}\n\n\t\t\t$(window).one('action:chat.loaded', function () {\n\t\t\t\tcomponents.get('chat/input').val(text);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addScrollHandler = function (roomId, uid, el) {\n\t\tvar loading = false;\n\t\tel.off('scroll').on('scroll', function () {\n\t\t\tmessages.toggleScrollUpAlert(el);\n\t\t\tif (loading) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar top = (el[0].scrollHeight - el.height()) * 0.1;\n\t\t\tif (el.scrollTop() >= top) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tloading = true;\n\t\t\tvar start = parseInt(el.children('[data-mid]').length, 10);\n\t\t\tsocket.emit('modules.chats.getMessages', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t\tstart: start,\n\t\t\t}, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (!data) {\n\t\t\t\t\tloading = false;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tdata = data.filter(function (chatMsg) {\n\t\t\t\t\treturn !$('[component=\"chat/message\"][data-mid=\"' + chatMsg.messageId + '\"]').length;\n\t\t\t\t});\n\t\t\t\tif (!data.length) {\n\t\t\t\t\tloading = false;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tmessages.parseMessage(data, function (html) {\n\t\t\t\t\tvar currentScrollTop = el.scrollTop();\n\t\t\t\t\tvar previousHeight = el[0].scrollHeight;\n\t\t\t\t\thtml = $(html);\n\t\t\t\t\tel.prepend(html);\n\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\thtml.find('img:not(.not-responsive)').addClass('img-responsive');\n\t\t\t\t\tel.scrollTop((el[0].scrollHeight - previousHeight) + currentScrollTop);\n\t\t\t\t\tloading = false;\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addScrollBottomHandler = function (chatContent) {\n\t\tchatContent.parent()\n\t\t\t.find('[component=\"chat/messages/scroll-up-alert\"]')\n\t\t\t.off('click').on('click', function () {\n\t\t\t\tmessages.scrollToBottom(chatContent);\n\t\t\t});\n\t};\n\n\tChats.addCharactersLeftHandler = function (parent) {\n\t\tvar element = parent.find('[component=\"chat/input\"]');\n\t\telement.on('change keyup paste', function () {\n\t\t\tmessages.updateRemainingLength(parent);\n\t\t});\n\t};\n\n\tChats.addActionHandlers = function (element, roomId) {\n\t\telement.on('click', '[data-action]', function () {\n\t\t\tvar messageId = $(this).parents('[data-mid]').attr('data-mid');\n\t\t\tvar action = this.getAttribute('data-action');\n\n\t\t\tswitch (action) {\n\t\t\t\tcase 'edit':\n\t\t\t\t\tvar inputEl = $('[data-roomid=\"' + roomId + '\"] [component=\"chat/input\"]');\n\t\t\t\t\tmessages.prepEdit(inputEl, messageId, roomId);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'delete':\n\t\t\t\t\tmessages.delete(messageId, roomId);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'restore':\n\t\t\t\t\tmessages.restore(messageId, roomId);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addHotkeys = function () {\n\t\tmousetrap.bind('ctrl+up', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar prev = activeContact.prev();\n\n\t\t\tif (prev.length) {\n\t\t\t\tChats.switchChat(prev.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('ctrl+down', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar next = activeContact.next();\n\n\t\t\tif (next.length) {\n\t\t\t\tChats.switchChat(next.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('up', function (e) {\n\t\t\tif (e.target === components.get('chat/input').get(0)) {\n\t\t\t\t// Retrieve message id from messages list\n\t\t\t\tvar message = components.get('chat/messages').find('.chat-message[data-self=\"1\"]').last();\n\t\t\t\tif (!message.length) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvar lastMid = message.attr('data-mid');\n\t\t\t\tvar inputEl = components.get('chat/input');\n\n\t\t\t\tmessages.prepEdit(inputEl, lastMid, ajaxify.data.roomId);\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addMemberHandler = function (roomId, buttonEl) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tapp.parseAndTranslate('partials/modals/manage_room', {}, function (html) {\n\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\ttitle: '[[modules:chat.manage-room]]',\n\t\t\t\t\tmessage: html,\n\t\t\t\t});\n\n\t\t\t\tmodal.attr('component', 'chat/manage-modal');\n\n\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t\tChats.addKickHandler(roomId, modal);\n\n\t\t\t\tvar searchInput = modal.find('input');\n\t\t\t\tvar errorEl = modal.find('.text-danger');\n\t\t\t\trequire(['autocomplete', 'translator'], function (autocomplete, translator) {\n\t\t\t\t\tautocomplete.user(searchInput, function (event, selected) {\n\t\t\t\t\t\terrorEl.text('');\n\t\t\t\t\t\tsocket.emit('modules.chats.addUserToRoom', {\n\t\t\t\t\t\t\troomId: roomId,\n\t\t\t\t\t\t\tusername: selected.item.user.name,\n\t\t\t\t\t\t}, function (err) {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\ttranslator.translate(err.message, function (translated) {\n\t\t\t\t\t\t\t\t\terrorEl.text(translated);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t\t\t\t\tsearchInput.val('');\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addKickHandler = function (roomId, modal) {\n\t\tmodal.on('click', '[data-action=\"kick\"]', function () {\n\t\t\tvar uid = parseInt(this.getAttribute('data-uid'), 10);\n\n\t\t\tsocket.emit('modules.chats.removeUserFromRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addLeaveHandler = function (roomId, buttonEl) {\n\t\tbuttonEl.on('click', function () {\n\t\t\tbootbox.confirm({\n\t\t\t\tsize: 'small',\n\t\t\t\ttitle: '[[modules:chat.leave]]',\n\t\t\t\tmessage: '<p>[[modules:chat.leave-prompt]]</p><p class=\"help-block\">[[modules:chat.leave-help]]</p>',\n\t\t\t\tcallback: function (ok) {\n\t\t\t\t\tif (ok) {\n\t\t\t\t\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Return user to chats page. If modal, close modal.\n\t\t\t\t\t\t\tvar modal = buttonEl.parents('.chat-modal');\n\t\t\t\t\t\t\tif (modal.length) {\n\t\t\t\t\t\t\t\trequire(['chat'], function (chatLib) {\n\t\t\t\t\t\t\t\t\tchatLib.close(modal);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tajaxify.go('chats');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.refreshParticipantsList = function (roomId, modal) {\n\t\tsocket.emit('modules.chats.getUsersInRoom', { roomId: roomId }, function (err, users) {\n\t\t\tvar listEl = modal.find('.list-group');\n\n\t\t\tif (err) {\n\t\t\t\treturn translator.translate('[[error:invalid-data]]', function (translated) {\n\t\t\t\t\tlistEl.find('li').text(translated);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tapp.parseAndTranslate('partials/modals/manage_room_users', {\n\t\t\t\tusers: users,\n\t\t\t}, function (html) {\n\t\t\t\tlistEl.html(html);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addRenameHandler = function (roomId, buttonEl, roomName) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tapp.parseAndTranslate('partials/modals/rename_room', {\n\t\t\t\tname: roomName || ajaxify.data.roomName,\n\t\t\t}, function (html) {\n\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\ttitle: '[[modules:chat.rename-room]]',\n\t\t\t\t\tmessage: html,\n\t\t\t\t\tbuttons: {\n\t\t\t\t\t\tsave: {\n\t\t\t\t\t\t\tlabel: '[[global:save]]',\n\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tfunction submit() {\n\t\t\tsocket.emit('modules.chats.renameRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tnewName: modal.find('#roomName').val(),\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tChats.addSendHandlers = function (roomId, inputEl, sendEl) {\n\t\tinputEl.off('keypress').on('keypress', function (e) {\n\t\t\tif (e.which === 13 && !e.shiftKey) {\n\t\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\tsendEl.off('click').on('click', function () {\n\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\tinputEl.focus();\n\t\t\treturn false;\n\t\t});\n\t};\n\n\tChats.createAutoComplete = function (element) {\n\t\tif (!element.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar data = {\n\t\t\telement: element,\n\t\t\tstrategies: [],\n\t\t\toptions: {\n\t\t\t\tstyle: {\n\t\t\t\t\t'z-index': 20000,\n\t\t\t\t\tflex: 0,\n\t\t\t\t\ttop: 'inherit',\n\t\t\t\t},\n\t\t\t\tplacement: 'top',\n\t\t\t},\n\t\t};\n\n\t\t$(window).trigger('chat:autocomplete:init', data);\n\t\tif (data.strategies.length) {\n\t\t\tautocomplete.setup(data);\n\t\t}\n\t};\n\n\tChats.leave = function (el) {\n\t\tvar roomId = el.attr('data-roomid');\n\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tif (parseInt(roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats');\n\t\t\t} else {\n\t\t\t\tel.remove();\n\t\t\t}\n\t\t\trequire(['chat'], function (chat) {\n\t\t\t\tvar modal = chat.getModal(roomId);\n\t\t\t\tif (modal.length) {\n\t\t\t\t\tchat.close(modal);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.switchChat = function (roomid) {\n\t\t// Allow empty arg for return to chat list/close chat\n\t\tif (!roomid) {\n\t\t\troomid = '';\n\t\t}\n\n\t\tvar url = 'user/' + ajaxify.data.userslug + '/chats/' + roomid + window.location.search;\n\t\tif (self.fetch) {\n\t\t\tfetch(config.relative_path + '/api/' + url, { credentials: 'include' })\n\t\t\t\t.then(function (response) {\n\t\t\t\t\tif (response.ok) {\n\t\t\t\t\t\tresponse.json().then(function (payload) {\n\t\t\t\t\t\t\tapp.parseAndTranslate('partials/chats/message-window', payload, function (html) {\n\t\t\t\t\t\t\t\tcomponents.get('chat/main-wrapper').html(html);\n\t\t\t\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\t\t\t\tChats.resizeMainWindow();\n\t\t\t\t\t\t\t\tajaxify.data = payload;\n\t\t\t\t\t\t\t\tChats.setActive();\n\t\t\t\t\t\t\t\tChats.addEventListeners();\n\t\t\t\t\t\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t\t\t\t\t\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\t\t\t\t\t\t\t\tif (history.pushState) {\n\t\t\t\t\t\t\t\t\thistory.pushState({\n\t\t\t\t\t\t\t\t\t\turl: url,\n\t\t\t\t\t\t\t\t\t}, null, window.location.protocol + '//' + window.location.host + config.relative_path + '/' + url);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('[search] Received ' + response.status);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(function (error) {\n\t\t\t\t\tconsole.warn('[search] ' + error.message);\n\t\t\t\t});\n\t\t} else {\n\t\t\tajaxify.go(url);\n\t\t}\n\t};\n\n\tChats.addGlobalEventListeners = function () {\n\t\t$(window).on('resize', Chats.resizeMainWindow);\n\t\t$(window).on('mousemove keypress click', function () {\n\t\t\tif (newMessage && ajaxify.data.roomId) {\n\t\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t\tnewMessage = false;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addSocketListeners = function () {\n\t\tsocket.on('event:chats.receive', function (data) {\n\t\t\tif (parseInt(data.roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tnewMessage = data.self === 0;\n\t\t\t\tdata.message.self = data.self;\n\n\t\t\t\tmessages.appendChatMessage($('.expanded-chat .chat-content'), data.message);\n\t\t\t} else if (ajaxify.data.template.chats) {\n\t\t\t\tvar roomEl = $('[data-roomid=' + data.roomId + ']');\n\n\t\t\t\tif (roomEl.length > 0) {\n\t\t\t\t\troomEl.addClass('unread');\n\t\t\t\t} else {\n\t\t\t\t\tvar recentEl = components.get('chat/recent');\n\t\t\t\t\tapp.parseAndTranslate('partials/chats/recent_room', {\n\t\t\t\t\t\trooms: {\n\t\t\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\t\t\tlastUser: data.message.fromUser,\n\t\t\t\t\t\t\tusernames: data.message.fromUser.username,\n\t\t\t\t\t\t\tunread: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t}, function (html) {\n\t\t\t\t\t\trecentEl.prepend(html);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tsocket.on('event:user_status_change', function (data) {\n\t\t\tapp.updateUserStatus($('.chats-list [data-uid=\"' + data.uid + '\"] [component=\"user/status\"]'), data.status);\n\t\t});\n\n\t\tmessages.addSocketListeners();\n\n\t\tsocket.on('event:chats.roomRename', function (data) {\n\t\t\tvar roomEl = components.get('chat/recent/room', data.roomId);\n\t\t\tvar titleEl = roomEl.find('[component=\"chat/title\"]');\n\t\t\tajaxify.data.roomName = data.newName;\n\n\t\t\ttitleEl.text(data.newName);\n\t\t});\n\t};\n\n\tChats.resizeMainWindow = function () {\n\t\tvar viewportHeight = $(window).height();\n\t\tvar mainWrapper = components.get('chat/main-wrapper');\n\t\tvar navWrapper = components.get('chat/nav-wrapper');\n\t\tvar fromTop = 0;\n\t\tif (mainWrapper.length && navWrapper.length) {\n\t\t\tfromTop = mainWrapper.offset().top || navWrapper.offset().top;\n\t\t}\n\n\t\t$('.chats-full').height(viewportHeight - fromTop - 1);\n\n\t\tChats.setActive();\n\t};\n\n\tChats.setActive = function () {\n\t\tif (ajaxify.data.roomId) {\n\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t$('[data-roomid=\"' + ajaxify.data.roomId + '\"]').toggleClass('unread', false);\n\t\t\t$('.expanded-chat [component=\"chat/input\"]').focus();\n\t\t}\n\t\t$('.chats-list li').removeClass('bg-info');\n\t\t$('.chats-list li[data-roomid=\"' + ajaxify.data.roomId + '\"]').addClass('bg-info');\n\n\t\tcomponents.get('chat/nav-wrapper').attr('data-loaded', ajaxify.data.roomId ? '1' : '0');\n\t};\n\n\n\treturn Chats;\n});\n"]}