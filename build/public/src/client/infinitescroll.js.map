{"version":3,"sources":["public/src/client/infinitescroll.js"],"names":["define","scroll","callback","previousScrollTop","loadingMore","container","scrollTimeout","init","el","cb","$","window","scrollTop","off","startScrollTimeout","on","clearTimeout","setTimeout","onScroll","bsEnv","utils","findBootstrapEnvironment","mobileComposerOpen","hasClass","currentScrollTop","wh","height","viewportHeight","offsetTop","offset","top","scrollPercent","bottom","direction","loadMore","method","data","hookData","trigger","socket","emit","err","app","alertError","message","loadMoreXhr","url","config","relative_path","location","pathname","replace","RegExp","get","fail","jqXHR","String","responseJSON","statusText","removeExtra","els","count","length","removeCount","document","slice","remove"],"mappings":"AAAA,aAGAA,OAAO,uBAAwB,WAC9B,IAAIC,KACJ,IAAIC,EACJ,IAAIC,EAAoB,EACxB,IAAIC,EAAc,MAClB,IAAIC,EACJ,IAAIC,EAAgB,EAEpBL,EAAOM,KAAO,SAAUC,EAAIC,GAC3B,UAAWD,IAAO,WAAY,CAC7BN,EAAWM,EACXH,EAAYK,EAAE,YACR,CACNR,EAAWO,EACXJ,EAAYG,GAAME,EAAE,QAErBP,EAAoBO,EAAEC,QAAQC,YAC9BF,EAAEC,QAAQE,IAAI,SAAUC,GAAoBC,GAAG,SAAUD,IAG1D,SAASA,IACR,GAAIR,EAAe,CAClBU,aAAaV,GAEdA,EAAgBW,WAAW,WAC1BX,EAAgB,EAChBY,KACE,IAGJ,SAASA,IACR,IAAIC,EAAQC,MAAMC,2BAClB,IAAIC,GAAsBH,IAAU,MAAQA,IAAU,OAAST,EAAE,QAAQa,SAAS,aAClF,GAAInB,GAAekB,EAAoB,CACtC,OAED,IAAIE,EAAmBd,EAAEC,QAAQC,YACjC,IAAIa,EAAKf,EAAEC,QAAQe,SACnB,IAAIC,EAAiBtB,EAAUqB,SAAWD,EAC1C,IAAIG,EAAYvB,EAAUwB,SAAWxB,EAAUwB,SAASC,IAAM,EAC9D,IAAIC,EAAgB,KAAOP,EAAmBI,IAAcD,GAAkB,EAAIF,EAAKE,GAEvF,IAAIG,EAAM,GACV,IAAIE,EAAS,GACb,IAAIC,EAAYT,EAAmBrB,EAAoB,GAAK,EAE5D,GAAI4B,EAAgBD,GAAON,EAAmBrB,EAAmB,CAChED,EAAS+B,QACH,GAAIF,EAAgBC,GAAUR,EAAmBrB,EAAmB,CAC1ED,EAAS+B,QACH,GAAIF,EAAgB,GAAKE,EAAY,GAAKN,EAAiB,EAAG,CACpEzB,EAAS+B,GAGV9B,EAAoBqB,EAGrBvB,EAAOiC,SAAW,SAAUC,EAAQC,EAAMlC,GACzC,GAAIE,EAAa,CAChB,OAEDA,EAAc,KAEd,IAAIiC,GAAaF,OAAQA,EAAQC,KAAMA,GACvC1B,EAAEC,QAAQ2B,QAAQ,iCAAkCD,GAEpDE,OAAOC,KAAKH,EAASF,OAAQE,EAASD,KAAM,SAAUK,EAAKL,GAC1D,GAAIK,EAAK,CACRrC,EAAc,MACd,OAAOsC,IAAIC,WAAWF,EAAIG,SAE3B1C,EAASkC,EAAM,WACdhC,EAAc,WAKjBH,EAAO4C,YAAc,SAAUT,EAAMlC,GACpC,GAAIE,EAAa,CAChB,OAEDA,EAAc,KACd,IAAI0C,EAAMC,OAAOC,cAAgB,OAASC,SAASC,SAASC,QAAQ,IAAIC,OAAO,IAAML,OAAOC,eAAgB,IAC5G,IAAIX,GAAaS,IAAKA,EAAKV,KAAMA,GACjC1B,EAAEC,QAAQ2B,QAAQ,qCAAsCD,GAExD3B,EAAE2C,IAAIP,EAAKV,EAAM,SAAUA,GAC1BlC,EAASkC,EAAM,WACdhC,EAAc,UAEbkD,KAAK,SAAUC,GACjBnD,EAAc,MACdsC,IAAIC,WAAWa,OAAOD,EAAME,cAAgBF,EAAMG,gBAIpDzD,EAAO0D,YAAc,SAAUC,EAAK3B,EAAW4B,GAC9C,GAAID,EAAIE,QAAUD,EAAO,CACxB,OAGD,IAAIE,EAAcH,EAAIE,OAASD,EAC/B,GAAI5B,EAAY,EAAG,CAClB,IAAIP,EAAShB,EAAEsD,UAAUtC,SACzB,IAAId,EAAYF,EAAEC,QAAQC,YAE1BgD,EAAIK,MAAM,EAAGF,GAAaG,SAE1BxD,EAAEC,QAAQC,UAAUA,GAAaF,EAAEsD,UAAUtC,SAAWA,QAClD,CACNkC,EAAIK,MAAML,EAAIE,OAASC,GAAaG,WAItC,OAAOjE","file":"public/src/client/infinitescroll.js","sourcesContent":["'use strict';\n\n\ndefine('forum/infinitescroll', function () {\n\tvar scroll = {};\n\tvar callback;\n\tvar previousScrollTop = 0;\n\tvar loadingMore\t= false;\n\tvar container;\n\tvar scrollTimeout = 0;\n\n\tscroll.init = function (el, cb) {\n\t\tif (typeof el === 'function') {\n\t\t\tcallback = el;\n\t\t\tcontainer = $('body');\n\t\t} else {\n\t\t\tcallback = cb;\n\t\t\tcontainer = el || $('body');\n\t\t}\n\t\tpreviousScrollTop = $(window).scrollTop();\n\t\t$(window).off('scroll', startScrollTimeout).on('scroll', startScrollTimeout);\n\t};\n\n\tfunction startScrollTimeout() {\n\t\tif (scrollTimeout) {\n\t\t\tclearTimeout(scrollTimeout);\n\t\t}\n\t\tscrollTimeout = setTimeout(function () {\n\t\t\tscrollTimeout = 0;\n\t\t\tonScroll();\n\t\t}, 60);\n\t}\n\n\tfunction onScroll() {\n\t\tvar bsEnv = utils.findBootstrapEnvironment();\n\t\tvar mobileComposerOpen = (bsEnv === 'xs' || bsEnv === 'sm') && $('html').hasClass('composing');\n\t\tif (loadingMore || mobileComposerOpen) {\n\t\t\treturn;\n\t\t}\n\t\tvar currentScrollTop = $(window).scrollTop();\n\t\tvar wh = $(window).height();\n\t\tvar viewportHeight = container.height() - wh;\n\t\tvar offsetTop = container.offset() ? container.offset().top : 0;\n\t\tvar scrollPercent = 100 * (currentScrollTop - offsetTop) / (viewportHeight <= 0 ? wh : viewportHeight);\n\n\t\tvar top = 15;\n\t\tvar bottom = 85;\n\t\tvar direction = currentScrollTop > previousScrollTop ? 1 : -1;\n\n\t\tif (scrollPercent < top && currentScrollTop < previousScrollTop) {\n\t\t\tcallback(direction);\n\t\t} else if (scrollPercent > bottom && currentScrollTop > previousScrollTop) {\n\t\t\tcallback(direction);\n\t\t} else if (scrollPercent < 0 && direction > 0 && viewportHeight < 0) {\n\t\t\tcallback(direction);\n\t\t}\n\n\t\tpreviousScrollTop = currentScrollTop;\n\t}\n\n\tscroll.loadMore = function (method, data, callback) {\n\t\tif (loadingMore) {\n\t\t\treturn;\n\t\t}\n\t\tloadingMore = true;\n\n\t\tvar hookData = { method: method, data: data };\n\t\t$(window).trigger('action:infinitescroll.loadmore', hookData);\n\n\t\tsocket.emit(hookData.method, hookData.data, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\tloadingMore = false;\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tcallback(data, function () {\n\t\t\t\tloadingMore = false;\n\t\t\t});\n\t\t});\n\t};\n\n\tscroll.loadMoreXhr = function (data, callback) {\n\t\tif (loadingMore) {\n\t\t\treturn;\n\t\t}\n\t\tloadingMore = true;\n\t\tvar url = config.relative_path + '/api' + location.pathname.replace(new RegExp('^' + config.relative_path), '');\n\t\tvar hookData = { url: url, data: data };\n\t\t$(window).trigger('action:infinitescroll.loadmore.xhr', hookData);\n\n\t\t$.get(url, data, function (data) {\n\t\t\tcallback(data, function () {\n\t\t\t\tloadingMore = false;\n\t\t\t});\n\t\t}).fail(function (jqXHR) {\n\t\t\tloadingMore = false;\n\t\t\tapp.alertError(String(jqXHR.responseJSON || jqXHR.statusText));\n\t\t});\n\t};\n\n\tscroll.removeExtra = function (els, direction, count) {\n\t\tif (els.length <= count) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar removeCount = els.length - count;\n\t\tif (direction > 0) {\n\t\t\tvar height = $(document).height();\n\t\t\tvar scrollTop = $(window).scrollTop();\n\n\t\t\tels.slice(0, removeCount).remove();\n\n\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\n\t\t} else {\n\t\t\tels.slice(els.length - removeCount).remove();\n\t\t}\n\t};\n\n\treturn scroll;\n});\n"]}