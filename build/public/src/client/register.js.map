{"version":3,"sources":["public/src/client/register.js"],"names":["define","translator","zxcvbn","slugify","api","Login","Register","validationError","successIcon","init","email","$","username","password","password_confirm","register","handleLanguageOverride","val","on","length","validateEmail","query","utils","params","token","decodeURIComponent","text","this","value","validateUsername","validatePassword","validatePasswordConfirm","validateForm","callback","capsLockCheck","document","querySelector","e","registerBtn","errorEl","addClass","preventDefault","parents","ajaxSubmit","headers","x-csrf-token","config","csrf_token","success","data","removeClass","next","pathname","urlToLocation","url","registered","qs","param","window","location","href","message","translate","msg","bootbox","alert","ajaxify","go","error","responseText","defaultLang","translated","status","relative_path","find","focus","email_notify","isEmailValid","showError","socket","emit","err","exists","app","alertError","showSuccess","username_notify","userslug","minimumUsernameLength","maximumUsernameLength","isUserNameValid","Promise","allSettled","head","then","results","every","obj","password_notify","password_confirm_notify","passwordStrength","minimumPasswordLength","isPasswordValid","score","minimumPasswordStrength","hasClass","element","html","parent","show","user","uid","userLang","formEl","langEl","append"],"mappings":"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","file":"public/src/client/register.js","sourcesContent":["'use strict';\n\n\ndefine('forum/register', [\n\t'translator', 'zxcvbn', 'slugify', 'api', 'forum/login', 'jquery-form',\n], function (translator, zxcvbn, slugify, api, Login) {\n\tvar Register = {};\n\tvar validationError = false;\n\tvar successIcon = '';\n\n\tRegister.init = function () {\n\t\tvar email = $('#email');\n\t\tvar username = $('#username');\n\t\tvar password = $('#password');\n\t\tvar password_confirm = $('#password-confirm');\n\t\tvar register = $('#register');\n\n\t\thandleLanguageOverride();\n\n\t\t$('#content #noscript').val('false');\n\n\t\temail.on('blur', function () {\n\t\t\tif (email.val().length) {\n\t\t\t\tvalidateEmail(email.val());\n\t\t\t}\n\t\t});\n\n\t\tvar query = utils.params();\n\t\tif (query.email && query.token) {\n\t\t\temail.val(decodeURIComponent(query.email));\n\t\t\t$('#token').val(query.token);\n\t\t}\n\n\t\t// Update the \"others can mention you via\" text\n\t\tusername.on('keyup', function () {\n\t\t\t$('#yourUsername').text(this.value.length > 0 ? slugify(this.value) : 'username');\n\t\t});\n\n\t\tusername.on('blur', function () {\n\t\t\tif (username.val().length) {\n\t\t\t\tvalidateUsername(username.val());\n\t\t\t}\n\t\t});\n\n\t\tpassword.on('blur', function () {\n\t\t\tif (password.val().length) {\n\t\t\t\tvalidatePassword(password.val(), password_confirm.val());\n\t\t\t}\n\t\t});\n\n\t\tpassword_confirm.on('blur', function () {\n\t\t\tif (password_confirm.val().length) {\n\t\t\t\tvalidatePasswordConfirm(password.val(), password_confirm.val());\n\t\t\t}\n\t\t});\n\n\t\tfunction validateForm(callback) {\n\t\t\tvalidationError = false;\n\t\t\tvalidatePassword(password.val(), password_confirm.val());\n\t\t\tvalidatePasswordConfirm(password.val(), password_confirm.val());\n\n\t\t\tvalidateEmail(email.val(), function () {\n\t\t\t\tvalidateUsername(username.val(), callback);\n\t\t\t});\n\t\t}\n\n\t\t// Guard against caps lock\n\t\tLogin.capsLockCheck(document.querySelector('#password'), document.querySelector('#caps-lock-warning'));\n\n\t\tregister.on('click', function (e) {\n\t\t\tvar registerBtn = $(this);\n\t\t\tvar errorEl = $('#register-error-notify');\n\t\t\terrorEl.addClass('hidden');\n\t\t\te.preventDefault();\n\t\t\tvalidateForm(function () {\n\t\t\t\tif (validationError) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tregisterBtn.addClass('disabled');\n\n\t\t\t\tregisterBtn.parents('form').ajaxSubmit({\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t'x-csrf-token': config.csrf_token,\n\t\t\t\t\t},\n\t\t\t\t\tsuccess: function (data) {\n\t\t\t\t\t\tregisterBtn.removeClass('disabled');\n\t\t\t\t\t\tif (!data) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (data.next) {\n\t\t\t\t\t\t\tvar pathname = utils.urlToLocation(data.next).pathname;\n\n\t\t\t\t\t\t\tvar params = utils.params({ url: data.next });\n\t\t\t\t\t\t\tparams.registered = true;\n\t\t\t\t\t\t\tvar qs = decodeURIComponent($.param(params));\n\n\t\t\t\t\t\t\twindow.location.href = pathname + '?' + qs;\n\t\t\t\t\t\t} else if (data.message) {\n\t\t\t\t\t\t\ttranslator.translate(data.message, function (msg) {\n\t\t\t\t\t\t\t\tbootbox.alert(msg);\n\t\t\t\t\t\t\t\tajaxify.go('/');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\terror: function (data) {\n\t\t\t\t\t\ttranslator.translate(data.responseText, config.defaultLang, function (translated) {\n\t\t\t\t\t\t\tif (data.status === 403 && data.responseText === 'Forbidden') {\n\t\t\t\t\t\t\t\twindow.location.href = config.relative_path + '/register?error=csrf-invalid';\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\terrorEl.find('p').text(translated);\n\t\t\t\t\t\t\t\terrorEl.removeClass('hidden');\n\t\t\t\t\t\t\t\tregisterBtn.removeClass('disabled');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\t// Set initial focus\n\t\t$('#email').focus();\n\t};\n\n\tfunction validateEmail(email, callback) {\n\t\tcallback = callback || function () {};\n\t\tvar email_notify = $('#email-notify');\n\n\t\tif (!utils.isEmailValid(email)) {\n\t\t\tshowError(email_notify, '[[error:invalid-email]]');\n\t\t\treturn callback();\n\t\t}\n\n\t\tsocket.emit('user.emailExists', {\n\t\t\temail: email,\n\t\t}, function (err, exists) {\n\t\t\tif (err) {\n\t\t\t\tapp.alertError(err.message);\n\t\t\t\treturn callback();\n\t\t\t}\n\n\t\t\tif (exists) {\n\t\t\t\tshowError(email_notify, '[[error:email-taken]]');\n\t\t\t} else {\n\t\t\t\tshowSuccess(email_notify, successIcon);\n\t\t\t}\n\n\t\t\tcallback();\n\t\t});\n\t}\n\n\tfunction validateUsername(username, callback) {\n\t\tcallback = callback || function () {};\n\n\t\tvar username_notify = $('#username-notify');\n\t\tvar userslug = slugify(username);\n\t\tif (username.length < ajaxify.data.minimumUsernameLength || userslug.length < ajaxify.data.minimumUsernameLength) {\n\t\t\tshowError(username_notify, '[[error:username-too-short]]');\n\t\t} else if (username.length > ajaxify.data.maximumUsernameLength) {\n\t\t\tshowError(username_notify, '[[error:username-too-long]]');\n\t\t} else if (!utils.isUserNameValid(username) || !userslug) {\n\t\t\tshowError(username_notify, '[[error:invalid-username]]');\n\t\t} else {\n\t\t\tPromise.allSettled([\n\t\t\t\tapi.head(`/users/bySlug/${username}`, {}),\n\t\t\t\tapi.head(`/groups/${username}`, {}),\n\t\t\t]).then((results) => {\n\t\t\t\tif (results.every(obj => obj.status === 'rejected')) {\n\t\t\t\t\tshowSuccess(username_notify, successIcon);\n\t\t\t\t} else {\n\t\t\t\t\tshowError(username_notify, '[[error:username-taken]]');\n\t\t\t\t}\n\n\t\t\t\tcallback();\n\t\t\t});\n\t\t}\n\t}\n\n\tfunction validatePassword(password, password_confirm) {\n\t\tvar password_notify = $('#password-notify');\n\t\tvar password_confirm_notify = $('#password-confirm-notify');\n\t\tvar passwordStrength = zxcvbn(password);\n\n\t\tif (password.length < ajaxify.data.minimumPasswordLength) {\n\t\t\tshowError(password_notify, '[[reset_password:password_too_short]]');\n\t\t} else if (password.length > 512) {\n\t\t\tshowError(password_notify, '[[error:password-too-long]]');\n\t\t} else if (!utils.isPasswordValid(password)) {\n\t\t\tshowError(password_notify, '[[user:change_password_error]]');\n\t\t} else if (password === $('#username').val()) {\n\t\t\tshowError(password_notify, '[[user:password_same_as_username]]');\n\t\t} else if (password === $('#email').val()) {\n\t\t\tshowError(password_notify, '[[user:password_same_as_email]]');\n\t\t} else if (passwordStrength.score < ajaxify.data.minimumPasswordStrength) {\n\t\t\tshowError(password_notify, '[[user:weak_password]]');\n\t\t} else {\n\t\t\tshowSuccess(password_notify, successIcon);\n\t\t}\n\n\t\tif (password !== password_confirm && password_confirm !== '') {\n\t\t\tshowError(password_confirm_notify, '[[user:change_password_error_match]]');\n\t\t}\n\t}\n\n\tfunction validatePasswordConfirm(password, password_confirm) {\n\t\tvar password_notify = $('#password-notify');\n\t\tvar password_confirm_notify = $('#password-confirm-notify');\n\n\t\tif (!password || password_notify.hasClass('alert-error')) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (password !== password_confirm) {\n\t\t\tshowError(password_confirm_notify, '[[user:change_password_error_match]]');\n\t\t} else {\n\t\t\tshowSuccess(password_confirm_notify, successIcon);\n\t\t}\n\t}\n\n\tfunction showError(element, msg) {\n\t\ttranslator.translate(msg, function (msg) {\n\t\t\telement.html(msg);\n\t\t\telement.parent()\n\t\t\t\t.removeClass('register-success')\n\t\t\t\t.addClass('register-danger');\n\t\t\telement.show();\n\t\t});\n\t\tvalidationError = true;\n\t}\n\n\tfunction showSuccess(element, msg) {\n\t\ttranslator.translate(msg, function (msg) {\n\t\t\telement.html(msg);\n\t\t\telement.parent()\n\t\t\t\t.removeClass('register-danger')\n\t\t\t\t.addClass('register-success');\n\t\t\telement.show();\n\t\t});\n\t}\n\n\tfunction handleLanguageOverride() {\n\t\tif (!app.user.uid && config.defaultLang !== config.userLang) {\n\t\t\tvar formEl = $('[component=\"register/local\"]');\n\t\t\tvar langEl = $('<input type=\"hidden\" name=\"userLang\" value=\"' + config.userLang + '\" />');\n\n\t\t\tformEl.append(langEl);\n\t\t}\n\t}\n\n\treturn Register;\n});\n"]}